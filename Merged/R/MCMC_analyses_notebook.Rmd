---
title: "Bayesian Regression Results for Covid Project"
output: 
  rmarkdown::github_document:
    toc: true
    #toc_float: true
    toc_depth: 4
---

This is an R markdown file to run the Regression Analysis for manuscript 'Overestimating the intensity of negative emotion in autobiographical memory: evidence from the 9/11 attack and Covid-19 pandemic'

For plotting, please see the Plot_notebook.Rmd

Besides providing the data files needed to run the analysis, we have also provided a saved rds file storing all the MCMC objects. You could download it from OSF [OSF link] and place it in the data folder

For any question, contact Haoxue (haoxue_fan@g.harvard.edu) or Johnny (jcastillo@g.harvard.edu)

```{r load dependency and datafile, include=FALSE}
# source some helper functions
source('utils.R')
# read in data
# if you wish to load in the saved RData file, uncomment the line below
load(file = '../data/BayesRegObj.RData')
load(file= '../data/BayesRegObj_911Extra.RData')
load(file= '../data/BayesRegObj_911Extra2.RData')
covid_wide <-  read.csv('../data/Complete_test_Dev_Exp_Only_Data_Manipulation.csv') #each row is one observation, T1 and T2 separated by prefix in the column
nine11_long_avg <- read.csv('../data/df.emo.long.avg_Only_Data_Manipulation.csv') #each row is one observation at one time point, stress_memory is avg across emotions

#  filter time2 data frome 911 to do shared analysis 
nine11_long_avg_T2 <- nine11_long_avg %>% filter(time==2)

## define var related to MCMC
niters <- 40000
niters_supp <- 4000
seed_no <- 1636
```

# Demographic

## Covid

```{r demo}
covid_wide$T1_Demographics_gender %>% table(useNA='ifany')
covid_wide$T1_Demographics_race %>% table(useNA = 'ifany')
covid_wide$T1_Demographics_HispanicLatino %>% table(useNA = 'ifany')
```

## 911

```{r}
df.emo.demo <- read.csv('../data/df.911.demo.csv')

nine11_long_avg_T2.demo <- nine11_long_avg_T2 %>% filter(!is.na(prev_experience) & !is.na(curr_experience)) %>% left_join(df.emo.demo) 
nine11_long_avg_T2.demo$gender %>% table(useNA = 'ifany')
c(nine11_long_avg_T2.demo$age %>% mean(na.rm=T), nine11_long_avg_T2.demo$age %>% var(na.rm=T) %>% sqrt)
nine11_long_avg_T2.demo$race_1 %>% table(useNA = 'ifany')

nine11_long_avg.demo <- nine11_long_avg %>% filter(!is.na(memdev) & !is.na(prev_experience)) %>% left_join(df.emo.demo) %>% group_by(Subject) %>% slice(1)
nine11_long_avg.demo$gender %>% table(useNA = 'ifany')
c(nine11_long_avg.demo$age %>% mean(na.rm=T), nine11_long_avg.demo$age %>% var(na.rm=T) %>% sqrt)
nine11_long_avg.demo$race_1 %>% table(useNA = 'ifany')
```

# Stress (NegEmo) ~ type (T1_experienced/T2_remembered/T2_experienced)

This analysis answers the q: Does T1_experienced / T2_remembered / T2_experienced differ from each other? 

## Covid
```{r }
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))
n_ppt <- length(unique(covid_long_type$Subject)) #Calculate number of participants; 726
covid_long_type %>% group_by(MemType) %>% 
  summarise(mean=mean(BStress, na.rm=T), se=sd(BStress, na.rm=T)/sqrt(n_ppt))

#  sanity check: BStress has been beta_squeezed and looks like a beta distribution (that is, fall between 0 and 1)
covid_long_type %>% ggplot(aes(x=BStress)) + geom_histogram(bins = 20) + facet_wrap(~MemType)
if (!exists("MemType_covid_MCMC")) {
MemType_covid_MCMC <- stan_glmer(BStress ~ MemType + (1|Subject), 
                              family = mgcv::betar, iter= niters, seed=seed_no, data = covid_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_covid_MCMC<- covid_long_type$BStress
yrep_y_MemType_covid_MCMC <- posterior_predict(MemType_covid_MCMC, draws = 500)
#Summarize Posterior
plot_model(MemType_covid_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_covid_MCMC)
```

People's T2_experienced covid stress is smaller than T1_experienced, while T2_remembered is higher than T1_experienced.

Note that in the plot above (and the model) the DVs have been beta transformed.

If we want to see the results on its original scale, we will need to run the same analysis but this time possibly use a beta linear mixed regrsssion.

### Covariate

This set of analysis tries to answer the question: what are some moderators in the relationship between previous, current, and remembered negative emotion experience? Given the impact of covid and 9/11 to our life, it is important to document how it may impact different population differently. Here given the data collected, we focus on the potential moderating role of gender, race, and ethnicity. 

```{r covariate covid}
# Before we get started, we cleaned up the race variable by creating a new variable called 'mix' to include all people who identify with more than one race
covid_long_type <- covid_long_type %>% 
  mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))

# gender
if (!exists("MemType_covid_MCMC_covariate_gender")){
MemType_covid_MCMC_covariate_gender <- stan_glmer(BStress ~ MemType*(T1_Demographics_gender) + (1|Subject), 
                              family = mgcv::betar, iter= niters_supp, seed=seed_no, 
                              data = covid_long_type)}
summary(MemType_covid_MCMC_covariate_gender, pars = c("alpha", "beta"))
summary(MemType_covid_MCMC_covariate_gender, pars = c("alpha", "beta"))[5:6,] # 0 is included in 95% credible interval

MemType_covid_MCMC_covariate_gender %>% emmeans(specs = 'MemType', by = 'T1_Demographics_gender') %>% contrast('trt.vs.ctrl') 

MemType_covid_MCMC_covariate_gender %>% emmeans(specs = c('MemType', 'T1_Demographics_gender')) %>% 
  contrast(list(c(1,-1,0, -1,1,0, 0,0,0), c(1,0,-1,-1,0,1,0,0,0)))

# race
if (!exists("MemType_covid_MCMC_covariate_race")){
MemType_covid_MCMC_covariate_race <- stan_glmer(BStress ~ MemType*(T1_Demographics_race_category) + (1|Subject), 
                              family = mgcv::betar, iter= niters_supp, seed=seed_no, 
                              data = covid_long_type)}
summary(MemType_covid_MCMC_covariate_race, pars = c("alpha", "beta"))
summary(MemType_covid_MCMC_covariate_race, pars = c("alpha", "beta"))[8:15,]
MemType_covid_MCMC_covariate_race %>% emmeans(specs = 'MemType', by = 'T1_Demographics_race_category') %>% contrast('trt.vs.ctrl') 
#MemType_covid_MCMC_covariate_race %>% emmeans(specs = 'T1_Demographics_race_category', by = 'MemType') %>% contrast('pairwise')
#if (!exists("MemType_covid_MCMC_covariate_race_refW")){
#MemType_covid_MCMC_covariate_race_refW <- stan_glmer(BStress ~ MemType*(T1_Demographics_race_category) + (1|Subject), 
#                              family = mgcv::betar, iter= niters_supp, seed=seed_no, 
#                              data = covid_long_type %>% mutate(T1_Demographics_race_category=relevel(factor(T1_Demographics_race_category), ref='White')))}
#summary(MemType_covid_MCMC_covariate_race_refW, pars=c('alpha','beta'))[8:15,]

MemType_covid_MCMC_covariate_race %>% emmeans(specs = c('MemType', 'T1_Demographics_race_category')) %>% 
  contrast(list(c(1,-1,0,-1,1,0,0,0,0,0,0,0,0,0,0),
                c(1,-1,0,0,0,0,0,0,0,0,0,0,-1,1,0),
                c(0,0,0,1,-1,0,0,0,0,0,0,0,-1,1,0),
                c(1,0,-1,-1,0,1,0,0,0,0,0,0,0,0,0),
                c(1,0,-1,0,0,0,0,0,0,0,0,0,-1,0,1),
                c(0,0,0,1,0,-1,0,0,0,0,0,0,-1,0,1)))

# ethnicity
if (!exists("MemType_covid_MCMC_covariate_eth")){
MemType_covid_MCMC_covariate_eth <- stan_glmer(BStress ~ MemType*(T1_Demographics_HispanicLatino) + (1|Subject), 
                              family = mgcv::betar, iter= niters_supp, seed=seed_no, 
                              data = covid_long_type)}
MemType_covid_MCMC_covariate_eth %>% emmeans(specs = 'MemType', by = 'T1_Demographics_HispanicLatino') %>% contrast('trt.vs.ctrl') 
MemType_covid_MCMC_covariate_eth %>% emmeans(specs = c('MemType',  'T1_Demographics_HispanicLatino')) %>% 
  contrast(list(c(1,-1,0,-1,1,0),
                c(1,0,-1,-1,0,1)))

if (!exists("MemType_covid_MCMC_covariate_ses_country")){
MemType_covid_MCMC_covariate_ses_country <- stan_glmer(BStress ~ MemType*(T1_SES_ladderCountry) + (1|Subject), 
                              family = mgcv::betar, iter= niters_supp, seed=seed_no, 
                              data = covid_long_type)}
ses_mean <- covid_wide$T1_SES_ladderCountry %>% mean(na.rm=T)
ses_std <- covid_wide$T1_SES_ladderCountry %>% var(na.rm=T) %>% sqrt
#MemType_covid_MCMC_covariate_ses_country %>% emmeans(specs = 'T1_SES_ladderCountry', by = 'MemType', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) %>% contrast('trt.vs.ctrl')
MemType_covid_MCMC_covariate_ses_country %>% emmeans(by = 'T1_SES_ladderCountry', specs  = 'MemType', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) %>% contrast('trt.vs.ctrl')

MemType_covid_MCMC_covariate_ses_country %>% emmeans(specs = c('T1_SES_ladderCountry', 'MemType'), at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std))) %>% 
  contrast(list(c(1,-1,-1,1,0,0),
                c(1,-1,0,0,-1,1)))
```

Let's quickly summarise our findings here: 
- gender: (1) both female and male demonstrate the pattern of T2_experienced stress < T1_experienced stress & T2_remembered > T1_experienced; (2) over three measurements, female participants demonstrate higher level of stress (i.e., higher T1_experienced, T2_experirenced, and T2_remembered stress) (we refrain from discussing other here given the insufficient sample size)
- race: (1) Asian and White participants demonstrate the pattern of T2_experienced stress < T1_experienced stress & T2_remembered > T1_experienced, while Black participants do not show difference T2_experienced vs. T1_experienced or T2_remembered vs. T1_experienced. Mixed participants do not show difference between T2_remembered vs. T1_experienced. (2) For T2_remembered, Asian participants remember higher stress than black participants. (we refrain from discussing other here given the insufficient sample size)
- ethnicity: (1) hispanic participants do not show difference between T2_experienced and T1_experienced stress at 95% HDI, but will show a difference at 90% HDI. There is no difference between the stress they experience at three data points separately.

(for graph, see the plot notebook)

## 911

To provide a fair comparison between Covid and 911, we focused on 911 survey 2 results (that is, the 1 year follow-up survey)

```{r}
nine11_long_type <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))
 #Number of 911 participants in case we also need it for SE
n_911_ppt <- length(unique(nine11_long_type$Subject)) #Calculate number of participants; 1430

#   sanity check: BNegEmo has been beta_squeezed
nine11_long_type %>% ggplot(aes(x=BNegEmo)) + geom_histogram(bins = 20) + facet_wrap(~MemType) # may worth noting that sanity check result for covid and 911 looks different
if (!exists("MemType_911_MCMC_T2")) {
MemType_911_MCMC_T2 <- stan_glmer(BNegEmo ~ MemType + (1|Subject), 
                                family = mgcv::betar, iter= niters, seed=seed_no,
                                data = nine11_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_911_MCMC_T2<- nine11_long_type$BNegEmo
yrep_MemType_911_MCMC_T2 <- posterior_predict(MemType_911_MCMC_T2, draws = 500)
#Summarize Posterior
plot_model(MemType_911_MCMC_T2, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_911_MCMC_T2)

```

### Covariate
```{r}
nine11_long_type <- nine11_long_type %>% left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

if (!exists("MemType_911_MCMC_T2_gender")){
MemType_911_MCMC_T2_gender <- stan_glmer(BNegEmo ~ MemType*gender + (1|Subject), 
                                family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                data = nine11_long_type)}
MemType_911_MCMC_T2_gender %>% emmeans(specs = 'MemType', by = 'gender') %>% contrast('trt.vs.ctrl')
MemType_911_MCMC_T2_gender %>% emmeans(specs = c('MemType', 'gender')) %>% 
  contrast(list(c(1,-1,0,-1,1,0,0,0,0),
                 c(1,0,-1,-1,0,1,0,0,0)))

#MemType_911_MCMC_T2_gender %>% emmeans(by = 'MemType', specs = 'gender') %>% contrast('trt.vs.ctrl')

if (!exists("MemType_911_MCMC_T2_race")){
MemType_911_MCMC_T2_race <- stan_glmer(BNegEmo ~ MemType*race_category + (1|Subject), 
                                family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                data = nine11_long_type)}
MemType_911_MCMC_T2_race %>% emmeans(specs = 'MemType', by = 'race_category') %>% contrast('trt.vs.ctrl')
MemType_911_MCMC_T2_race %>% emmeans(specs = c('MemType', 'race_category')) %>% 
  contrast(list(c(1,-1,0,-1,1,0,0,0,0,0,0,0), #neg
                c(1,-1,0,0,0,0,0,0,0,-1,1,0), #pos
                c(0,0,0,1,-1,0,0,0,0,-1,1,0), #pos
                c(1,0,-1,-1,0,1,0,0,0,0,0,0),
                c(1,0,-1,0,0,0,0,0,0,-1,0,1),
                c(0,0,0,1,0,-1,0,0,0,-1,0,1)))
#MemType_911_MCMC_T2_race %>% emmeans(by = 'MemType', specs = 'race_category') %>% contrast('trt.vs.ctrl')

if (!exists("MemType_911_MCMC_T2_eth")){
MemType_911_MCMC_T2_eth <- stan_glmer(BNegEmo ~ MemType*eth_category + (1|Subject), 
                                family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                data = nine11_long_type)}
MemType_911_MCMC_T2_eth %>% emmeans(specs = 'MemType', by = 'eth_category') %>% contrast('trt.vs.ctrl')
MemType_911_MCMC_T2_eth %>% emmeans(specs = c('MemType','eth_category')) %>% 
  contrast(list(c(1,-1,0,-1,1,0),
                 c(1,0,-1,-1,0,1)))

#if (!exists("MemType_911_MCMC_T2_origin")){
#MemType_911_MCMC_T2_origin <- stan_glmer(BNegEmo ~ MemType*origin + (1|Subject), 
#                                family = mgcv::betar, iter= niters_supp, seed=seed_no,
#                                data = nine11_long_type)}
#MemType_911_MCMC_T2_origin %>% emmeans(specs = 'MemType', by = 'origin') %>% contrast('trt.vs.ctrl')
#MemType_911_MCMC_T2_origin %>% emmeans(by = 'MemType', specs = 'origin') %>% contrast('trt.vs.ctrl')


```

### Discrete Neg Emo
```{r}
nine11_wide <- read.csv('../data/df.emo.wide_Only_Data_Manipulation.csv') %>% #each row is one observation at one time point, stress_memory is specific to one emotion
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

nine11_wide_type <- nine11_wide %>% dplyr::select(Subject, item, experienced1, experienced2, remembered2, memdev2) %>% rename(prev_experience=experienced1, curr_experience=experienced2, stress_memory=remembered2) %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))

# this one is pretty large
if (!exists("MemType_911_MCMC_T2_discrete")) {
MemType_911_MCMC_T2_discrete <- stan_glmer(BNegEmo ~ MemType*item + (1|Subject), 
                                family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                data = nine11_wide_type)
}
contrast(emmeans(MemType_911_MCMC_T2_discrete, ~ MemType*item, by='item'), 'trt.vs.ctrl')
contrast(emmeans(MemType_911_MCMC_T2_discrete, ~ MemType*item, by='MemType'), 'pairwise')

contrast(emmeans(MemType_911_MCMC_T2_discrete, ~ MemType*item), 'trt.vs.ctrl')

```

- for anger, confusion, fear, sadness and shock: follow the pattern of T2_experienced stress < T1_experienced stress & T2_remembered > T1_experienced; for frustration, T2_experienced stress < T1_experienced stress & T2_remembered does not differ from T1_experienced
- for each time point, there seem to exist difference between the level of intensity across different emotions that people are experiencing... not sure how much important it is to go into details here

### difference within single time point

In this section, we conducted additional analysis to compare the memory deviation (current DV) with the deviation across discrete emotion within single time point. 

```{r}
# some new efforts on doing the alternative analysis as the reviewer has suggested to visualize the within subject difference at each time point 

nine11_wide_wide_experienced1 <- nine11_wide %>% dplyr::select(Subject, item, experienced1, remembered2) %>% pivot_wider(id_cols = Subject, names_from = item, values_from = experienced1) 
names(nine11_wide_wide_experienced1) <- paste0('experienced_',names(nine11_wide_wide_experienced1))

nine11_wide_wide_remembered2 <- nine11_wide %>% dplyr::select(Subject, item, experienced1, remembered2) %>% pivot_wider(id_cols = Subject, names_from = item, values_from = remembered2) 
names(nine11_wide_wide_remembered2) <- paste0('remembered_',names(nine11_wide_wide_remembered2))

nine11_wide_wide <- nine11_wide_wide_experienced1 %>% rename(Subject=experienced_Subject) %>% 
  merge(
    nine11_wide_wide_remembered2 %>% 
      rename(Subject=remembered_Subject)
  )

nine11_wide_wide <- nine11_wide_wide %>% mutate(
  diff1 = abs(remembered_anger-experienced_anger),
  diff2 = abs(remembered_confusion-experienced_confusion),
  diff3 = abs(remembered_fear-experienced_fear),
  diff4 = abs(remembered_frustration-experienced_frustration),
  diff5 = abs(remembered_sadness-experienced_sadness),
  diff6 = abs(remembered_shock-experienced_shock),
  delta1  = abs(remembered_anger-remembered_confusion),
  delta2  = abs(remembered_anger-remembered_fear),
  delta3  = abs(remembered_anger-remembered_frustration),
  delta4  = abs(remembered_anger-remembered_sadness),
  delta5  = abs(remembered_anger-remembered_shock),
  delta6  = abs(remembered_confusion-remembered_fear),
  delta7  = abs(remembered_confusion-remembered_frustration),
  delta8  = abs(remembered_confusion-remembered_sadness),
  delta9  = abs(remembered_confusion-remembered_shock),
  delta10 = abs(remembered_fear-remembered_confusion),
  delta11 = abs(remembered_fear-remembered_confusion),
  delta12 = abs(remembered_fear-remembered_confusion),
  delta13 = abs(remembered_frustration-remembered_sadness),
  delta14 = abs(remembered_frustration-remembered_shock),
  delta15 = abs(remembered_sadness-remembered_shock),
) 
nine11_wide_wide$avg <- rowMeans(nine11_wide_wide %>% dplyr::select(starts_with('delta')))
nine11_wide_wide$diff_avg <- rowMeans(nine11_wide_wide %>% dplyr::select(starts_with('diff')))

t.test(nine11_wide_wide$diff_avg, nine11_wide_wide$avg, paired = TRUE) 
```

# Deviance  ~ Dataset (Covid/911_T2) + T1_experienced

In this analysis, we aim to compare whether people's degree of deviance differ between Covid and 9/11 data.

Because the range of response differs between two dataset, we use Deviance (transformed into Beta) as DV and use the data type and T1_experienced to predict it. 

A quick note that the reason that we moved away from percent is because that the meaning of a ratio is that the same magnitude of change means differently when the baseline is different. However, this is not what we mean here. Therefore, we decide to focus on the raw deviance score while controlling for baseline by including T1_experienced on the right hand side. We apologzie for the potential confusion caused by the fact that we still call the dataset covid_percent.. but our actual DV is the deviance score, not the percent.

Another quick note for the model specification: there is no random effect because each subject either contribute to the covid or the 9/11 dataset, but not both

```{r, include = FALSE}
# code in this chunk was related to percent, keep it here for now.
covid_percent <- covid_wide %>% mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) 
nine11_percent_T2 <- nine11_long_avg_T2 %>% mutate(Percent = memdev / twovar_prev_experience) %>% filter(!is.na(Percent))
combined_percent <- covid_percent %>% dplyr::select(Subject, Percent, Covid_Dev, twovar_Covid_Exp1, num_weights_2var) %>% 
  rename(dev = Covid_Dev, twovar_prev = twovar_Covid_Exp1, num_weights = num_weights_2var) %>% 
  mutate(Dataset = 'Covid') %>% 
  rbind(
    nine11_percent_T2 %>% dplyr::select(Subject, Percent, memdev, twovar_prev_experience, num_weights_updated) %>% 
      rename(dev = memdev, twovar_prev = twovar_prev_experience, num_weights = num_weights_updated) %>% 
      mutate(Dataset = '911')
  ) %>% 
  mutate(Dataset = relevel(factor(Dataset), ref = 'Covid')) %>% 
  group_by(Dataset) %>% 
  mutate(Bdev = beta_squeeze((dev+4)/8))

# sanity check: Percent looks like Gaussian
combined_percent %>% ggplot(aes(x=Percent)) + geom_histogram(bins = 100) + facet_wrap(~Dataset)

if (!exists("Dataset_Delta_baseline_MCMC")) {
Dataset_Delta_baseline_MCMC <- stan_glm(Bdev ~ Dataset + twovar_prev, family = mgcv::betar, iter= niters, seed=seed_no, data = combined_percent) 
}

#Posterior Predictive Check (Ppc)
y_Dataset_Delta_baseline_MCMC <- combined_percent$Bdev
#Summarize Posterior
plot_model(Dataset_Delta_baseline_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red") 
#emmeans(Dataset_Delta_baseline_MCMC, specs = 'Dataset') 
plot_model(Dataset_Delta_baseline_MCMC, terms= c('(Intercept)','Dataset911','twovar_prev')) + theme_sjplot()# any way to remove phi?; yes! done
# a different way to show the coefficient
mcmc_intervals(as.array(Dataset_Delta_baseline_MCMC), pars = c('(Intercept)','Dataset911','twovar_prev'))
describe_posterior(Dataset_Delta_baseline_MCMC) # more overestimation for 9-11
```
Interpretation of the results: after controlling for T1_experienced stress/negemo, people tend to overestimate more when recalling 9/11 negative emotion compared to covid-related stress.

# Rem ~ Exp1 + Exp2

Here, we ask the q: how does people reconstruct remembered stress/negemo? We suspect that besides the 'ground truth' T1_experienced, people's current stress will also play a role. Similar to previous analysis, Rem was converted to follow beta distribution. Also, the model specification does not include random effect.

## Covid
```{r}
covid_BRem <- covid_wide %>% mutate(BCovid_Rem = beta_squeeze((Covid_Rem-1)/4)) %>% 
  filter(!is.na(BCovid_Rem)) %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)) %>% 
  mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))
if (!exists("Rem_covid_MCMC_weighted")) {
Rem_covid_MCMC_weighted <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}

Rem_covid_MCMC_weighted_loss <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2 + personal_loss + finance_loss,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)

Rem_covid_MCMC_weighted_loss_cont <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2 + personal_loss + finance_loss_cont,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)

#Posterior Predictive Check (Ppc)
y_Rem_covid_MCMC_weighted <- covid_BRem$BCovid_Rem
#Summarize Posterior
#plot_model(Rem_covid_MCMC_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_covid_MCMC_weighted)
mcmc_intervals(as.array(Rem_covid_MCMC_weighted), pars = c('(Intercept)','Covid_Exp1','Covid_Exp2'))

# conduct the same analysis w/n weight specification - results are consistent
if (!exists("Rem_covid_MCMC_unweighted")) {
Rem_covid_MCMC_unweighted <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                    family = mgcv::betar, iter= niters, seed = seed_no,
                                    data = covid_BRem)
}
#plot_model(Rem_covid_MCMC_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
mcmc_intervals(as.array(Rem_covid_MCMC_unweighted), pars = c('(Intercept)','Covid_Exp1','Covid_Exp2'))
describe_posterior(Rem_covid_MCMC_unweighted)

```

When recalling covid-related stress, both current and prev stress influenced remembered stress, with prev stress inserts a larger influence.

### Covariate
```{r }
if (!exists("Rem_covid_MCMC_weighted_gender")){
Rem_covid_MCMC_weighted_gender <- stan_glm(BCovid_Rem ~ (Covid_Exp1 + Covid_Exp2) * T1_Demographics_gender,
                                  family = mgcv::betar, iter= niters_supp, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}
if (!exists("Rem_covid_MCMC_weighted_race")){
Rem_covid_MCMC_weighted_race <- stan_glm(BCovid_Rem ~ (Covid_Exp1 + Covid_Exp2) * T1_Demographics_race_category,
                                  family = mgcv::betar, iter= niters_supp, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}
if (!exists("Rem_covid_MCMC_weighted_eth")){
Rem_covid_MCMC_weighted_eth <- stan_glm(BCovid_Rem ~ (Covid_Exp1 + Covid_Exp2) * T1_Demographics_HispanicLatino,
                                  family = mgcv::betar, iter= niters_supp, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}
if (!exists("Rem_covid_MCMC_weighted_ses_country")){
Rem_covid_MCMC_weighted_ses_country <- stan_glm(BCovid_Rem ~ (Covid_Exp1 + Covid_Exp2) * T1_SES_ladderCountry,
                                  family = mgcv::betar, iter= niters_supp, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}

#summary(Rem_covid_MCMC_weighted_gender, pars = c("alpha", "beta"))
emtrends(Rem_covid_MCMC_weighted_gender, specs = 'T1_Demographics_gender', var = 'Covid_Exp1')
emtrends(Rem_covid_MCMC_weighted_gender, specs = 'T1_Demographics_gender', var = 'Covid_Exp2')

emtrends(Rem_covid_MCMC_weighted_gender, specs = 'T1_Demographics_gender', var = 'Covid_Exp1') %>% 
  rbind(emtrends(Rem_covid_MCMC_weighted_gender, specs = 'T1_Demographics_gender', var = 'Covid_Exp2')) %>% 
  contrast(list(c(1,-1,0,-1,1,0),
                c(1,0,0,-1,0,0),
                c(0,1,0,0,-1,0)))


emtrends(Rem_covid_MCMC_weighted_race, specs = 'T1_Demographics_race_category', var = 'Covid_Exp1')
emtrends(Rem_covid_MCMC_weighted_race, specs = 'T1_Demographics_race_category', var = 'Covid_Exp2')
emtrends(Rem_covid_MCMC_weighted_race, specs = 'T1_Demographics_race_category', var = 'Covid_Exp1') %>% 
  rbind(emtrends(Rem_covid_MCMC_weighted_race, specs = 'T1_Demographics_race_category', var = 'Covid_Exp2')) %>% 
  contrast(list(c(1,-1,0,0,0,-1,1,0,0,0),
                c(1,0,0,0,-1,-1,0,0,0,1),
                c(0,1,0,0,-1,0,-1,0,0,1),
                c(1,0,0,0,0,-1,0,0,0,0),
                c(0,1,0,0,0,0,-1,0,0,0),
                c(0,0,0,0,1,0,0,0,0,-1)))


emtrends(Rem_covid_MCMC_weighted_eth, specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp1')
emtrends(Rem_covid_MCMC_weighted_eth, specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp2')

emtrends(Rem_covid_MCMC_weighted_eth, specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp1') %>% 
  rbind(emtrends(Rem_covid_MCMC_weighted_eth, specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp2')) %>% 
  contrast(list(c(1,-1,-1,1),
                c(1,0,-1,0),
                c(0,1,0,-1)))

# still need to think about what interaction we are looking for
Rem_covid_MCMC_weighted_ses_country %>% emtrends(specs  = 'T1_SES_ladderCountry', var  = 'Covid_Exp1', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) 
Rem_covid_MCMC_weighted_ses_country %>% emtrends(specs  = 'T1_SES_ladderCountry', var  = 'Covid_Exp2', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) 

Rem_covid_MCMC_weighted_ses_country %>% emtrends(specs  = 'T1_SES_ladderCountry', var  = 'Covid_Exp1', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) %>% 
  rbind(Rem_covid_MCMC_weighted_ses_country %>% emtrends(specs  = 'T1_SES_ladderCountry', var  = 'Covid_Exp2', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) ) 
  

```

## 911
```{r}
nine11_BRem_T2 <- nine11_long_avg_T2 %>% mutate(B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  filter(!is.na(B911_Rem)) %>% filter(!is.na(prev_experience)) %>% filter(!is.na(curr_experience))
if (!exists("Rem_911_MCMC_T2_weighted")) {
Rem_911_MCMC_T2_weighted <- stan_glm(B911_Rem ~ prev_experience + curr_experience,
                                    family = mgcv::betar, iter= niters, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)
}
#Posterior Predictive Check (Ppc)
y_Rem_911_MCMC_T2_weighted <- nine11_BRem_T2$B911_Rem

#Summarize Posterior
#plot_model(Rem_911_MCMC_T2_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_911_MCMC_T2_weighted)

# without weight specification the results are consistent
if (!exists("Rem_911_MCMC_T2_unweighted")) {
Rem_911_MCMC_T2_unweighted <- stan_glm(B911_Rem ~ prev_experience + curr_experience,
                                     family = mgcv::betar, iter= niters, seed=seed_no,
                                     data = nine11_BRem_T2)
}
plot_model(Rem_911_MCMC_T2_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_911_MCMC_T2_unweighted)
mcmc_intervals(as.array(Rem_911_MCMC_T2_unweighted), pars = c('(Intercept)','prev_experience','curr_experience'))
```
### Covariate

```{r }
nine11_BRem_T2 <- nine11_BRem_T2 %>% 
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))
if (!exists("Rem_911_MCMC_T2_weighted_gender")){
Rem_911_MCMC_T2_weighted_gender <- stan_glm(B911_Rem ~ (prev_experience + curr_experience)*gender,
                                    family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)}
if (!exists("Rem_911_MCMC_T2_weighted_race")){
Rem_911_MCMC_T2_weighted_race <- stan_glm(B911_Rem ~ (prev_experience + curr_experience)*race_category,
                                    family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)}
if (!exists("Rem_911_MCMC_T2_weighted_eth")){
Rem_911_MCMC_T2_weighted_eth <- stan_glm(B911_Rem ~ (prev_experience + curr_experience)*eth_category,
                                    family = mgcv::betar, iter= niters_supp, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)}

emtrends(Rem_911_MCMC_T2_weighted_gender, specs = 'gender', var = 'prev_experience')
emtrends(Rem_911_MCMC_T2_weighted_gender, specs = 'gender', var = 'curr_experience')
emtrends(Rem_911_MCMC_T2_weighted_gender, specs = 'gender', var = 'prev_experience') %>% 
  rbind(emtrends(Rem_911_MCMC_T2_weighted_gender, specs = 'gender', var = 'curr_experience')) %>% 
  contrast(list(c(1,-1,0,-1,1,0),
                c(1,0,0,-1,0,0),
                c(0,1,0,0,-1,0)))


emtrends(Rem_911_MCMC_T2_weighted_race, specs = 'race_category', var = 'prev_experience')
emtrends(Rem_911_MCMC_T2_weighted_race, specs = 'race_category', var = 'curr_experience')

emtrends(Rem_911_MCMC_T2_weighted_race, specs = 'race_category', var = 'prev_experience') %>% 
  rbind(emtrends(Rem_911_MCMC_T2_weighted_race, specs = 'race_category', var = 'curr_experience')) %>% 
  contrast(list(c(1,-1,0,0,-1,1,0,0),
                c(1,0,0,-1,-1,0,0,1),
                c(0,1,0,-1,0,-1,0,1),
                c(1,0,0,0,-1,0,0,0),
                c(0,1,0,0,0,-1,0,0),
                c(0,0,0,1,0,0,0,-1)))

emtrends(Rem_911_MCMC_T2_weighted_eth, specs = 'eth_category', var = 'prev_experience')
emtrends(Rem_911_MCMC_T2_weighted_eth, specs = 'eth_category', var = 'curr_experience')

emtrends(Rem_911_MCMC_T2_weighted_eth, specs = 'eth_category', var = 'prev_experience') %>% 
  rbind(emtrends(Rem_911_MCMC_T2_weighted_eth, specs = 'eth_category', var = 'curr_experience')) %>% 
  contrast(list(c(1,-1,-1,1),
                c(1,0,-1,0),
                c(0,1,0,-1)))

```

### Discrete Neg Emo
```{r }
nine11_BRem_T2_discrete <- nine11_wide %>% dplyr::select(Subject, item, experienced1, experienced2, remembered2) %>% rename(prev_experience=experienced1, curr_experience=experienced2, stress_memory=remembered2) %>% 
  mutate(B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  filter(!is.na(B911_Rem)) %>% filter(!is.na(prev_experience)) %>% filter(!is.na(curr_experience))

if (!exists("Rem_911_MCMC_discrete")) {
Rem_911_MCMC_discrete <- stan_glmer(B911_Rem ~ (prev_experience + curr_experience) * item + (1|Subject),
                                     family = mgcv::betar, iter= niters_supp, seed = seed_no,
                                     data = nine11_BRem_T2_discrete)
}
emtrends(Rem_911_MCMC_discrete, specs = 'item', var = 'prev_experience')
```

# Dev ~ MemTime + prev_experience 

## 911

Using the 9/11 dataset, we test whether the deviation is a function of Time.
```{r}
nine11_percent <- nine11_long_avg %>% 
  #mutate(Percent = memdev / twovar_prev_experience) %>% 
  mutate(Bdev = (memdev+4)/8) %>% 
  mutate(time = relevel(factor(time), ref='2')) %>% 
  #filter(!is.na(Percent))
  filter(!is.na(Bdev)) %>% 
  filter(!is.na(prev_experience))


# Question to myself: I do not have this file stored?

if (!exists("Time_avg_911_MCMC_weighted")) {
Time_avg_911_MCMC_weighted <- stan_glmer(Bdev ~ time + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent)
}

# rerun the analysis above with a different reference level
if (!exists("Time_avg_911_MCMC_weighted_ref3")) {
Time_avg_911_MCMC_weighted_ref3 <- stan_glmer(Bdev ~ time + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent %>% mutate(time=relevel(time, ref='3')))
}

#Posterior Predictive Check (Ppc)
y_Time_avg_911_MCMC_weighted <- nine11_percent$Bdev
yrep_Time_avg_911_MCMC_weighted <- posterior_predict(Time_avg_911_MCMC_weighted, draws = 500)
#Summarize Posterior
plot_model(Time_avg_911_MCMC_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Time_avg_911_MCMC_weighted)

Time_avg_911_MCMC_unweighted_percent <- Time_avg_911_MCMC_unweighted
# remember to save it afterwards! 
if (!exists("Time_avg_911_MCMC_unweighted")) {
Time_avg_911_MCMC_unweighted <- stan_glmer(Bdev ~ time + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters, 
                             seed = seed_no,
                             data = nine11_percent)
}
plot_model(Time_avg_911_MCMC_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
#Posterior Predictive Check (Ppc)
y_Time_avg_911_MCMC_unweighted <- nine11_percent$Bdev
yrep_Time_avg_911_MCMC_unweighted <- posterior_predict(Time_avg_911_MCMC_unweighted, draws = 500) 

#Summarize Posterior
describe_posterior(Time_avg_911_MCMC_unweighted)

```
People overestimate neg emo more at 3-year follow-up than at 1-year and 10-years follow-up. There is no difference between the deviation of negative emotion recalled at 1-year and 10-years follow-up. 

### Covariate
```{r}
nine11_percent <- nine11_percent %>% 
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

if (!exists("Time_avg_911_MCMC_weighted_gender")) {
Time_avg_911_MCMC_weighted_gender <- stan_glmer(Bdev ~ time*gender + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters_supp, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent)
}
if (!exists("Time_avg_911_MCMC_weighted_race")) {
Time_avg_911_MCMC_weighted_race <- stan_glmer(Bdev ~ time*race_category + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters_supp, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent)
}
if (!exists("Time_avg_911_MCMC_weighted_eth")) {
Time_avg_911_MCMC_weighted_eth <- stan_glmer(Bdev ~ time*eth_category + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters_supp, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent)
}


Time_avg_911_MCMC_weighted_gender %>% emmeans(specs = 'time', by = 'gender') %>% contrast('trt.vs.ctrl') 
Time_avg_911_MCMC_weighted_gender %>% emmeans(specs = c('time', 'gender')) %>% 
  contrast(list(c(1,-1,0,-1,1,0,0,0,0),
                c(1,0,-1,-1,0,1,0,0,0),
                c(0,1,-1,0,-1,1,0,0,0)))

Time_avg_911_MCMC_weighted_race %>% emmeans(specs = 'time', by = 'race_category') %>% contrast('trt.vs.ctrl') 

Time_avg_911_MCMC_weighted_race %>% emmeans(specs = c('time', 'race_category')) %>%
  contrast(list(c(1,-1,0,-1,1,0,0,0,0,0,0,0),
                c(1,-1,0,0,0,0,0,0,0,-1,1,0),
                c(0,0,0,1,-1,0,0,0,0,-1,1,0),
                c(1,0,-1,-1,0,1,0,0,0,0,0,0),
                c(1,0,-1,0,0,0,0,0,0,-1,0,1),
                c(0,0,0,1,0,-1,0,0,0,-1,0,1)))
  
Time_avg_911_MCMC_weighted_eth %>% emmeans(specs = 'time', by = 'eth_category') %>% contrast('trt.vs.ctrl') 

Time_avg_911_MCMC_weighted_eth %>% emmeans(specs = c('time', 'eth_category')) %>% 
  contrast(list(c(1,-1,0,-1,1,0),
                c(1,0,-1,-1,0,1)))
```

### Discrete Neg Emo
```{r }
nine11_wide_subj_dev <- nine11_wide %>% dplyr::select(Subject, item, experienced1, memdev2, memdev3, memdev4) %>% 
  rename(prev_experience=experienced1) %>% 
  pivot_longer(cols = memdev2:memdev4, names_to = 'MemTime', values_to = 'Dev') %>% 
  mutate(item = relevel(factor(item), ref='frustration')) %>% 
  mutate(Bdev = beta_squeeze((Dev+4)/8)) %>% 
  filter(!is.na(Bdev)) %>% ungroup()

if (!exists("StressOTEmo911_MCMC_withprev")) {
StressOTEmo911_MCMC_withprev <- stan_glmer(Bdev ~ prev_experience + MemTime*item + (1|Subject), 
                                  family = mgcv::betar, 
                                  iter= niters_supp, seed=seed_no, data = nine11_wide_subj_dev) 
}
StressOTEmo911_MCMC_withprev %>% emmeans(specs = 'MemTime', by = 'item') %>% contrast('trt.vs.ctrl') 
#StressOTEmo911_MCMC %>% emmeans(specs = 'item', by = 'MemTime') %>% pairs() %>% plot # this graph is too messy

```
# Separate Analysis Overestimation ~ Delta Emotion Well-being

## Covid

Finally, we use Covid dataset and see whether there is any association between delta emotion well-being and deviation.


```{r}
# sanity check: people's emotion well being becomes better from T1 to T2.
if (!exists("covid_PCA_MCMC")) {
covid_PCA_MCMC <- stan_glm(emo_well_being_delta ~ 1,
                           family = "gaussian",
                           iter= niters, seed=seed_no, data = covid_wide)
}
#Posterior Predictive Check (Ppc)
y_covid_PCA_MCMC <- covid_wide %>% filter(emo_well_being_delta != "NA") %>% dplyr::select(emo_well_being_delta)
y_covid_PCA_MCMC <- y_covid_PCA_MCMC$emo_well_being_delta
yrep_covid_PCA_MCMC <- posterior_predict(covid_PCA_MCMC, draws = 500) #Good, but less peaked then the data
#Summarize Posterior
plot_model(covid_PCA_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(covid_PCA_MCMC)
```

```{r}
# controlled analysis: adding Covid_Exp1 as covariate
covid_percent <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  #mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) %>% 
  filter(!is.na(BCovid_Dev)) %>% filter(!is.na(emo_well_being_delta))
# A couple of regressions were run: 
# - covid_delta_EmoWell_MCMC: Dev ~ Emo_well_being + prev_experience
# - covid_delta_EmoWell_MCMC_both: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weights_3var (the most strict one)
# - covid_delta_EmoWell_MCMC_both_2var: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weight_2var (the most relevant one)
# - with suffix _betareg: for the purpose of posterior_predict 
if (!exists("covid_delta_EmoWell_MCMC")) {
covid_delta_EmoWell_MCMC <- stan_glm(BCovid_Dev ~ emo_well_being_delta + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_EmoWell_MCMC_both")) {
covid_delta_EmoWell_MCMC_both <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}
if (!exists("covid_delta_EmoWell_MCMC_both_2var")) {
covid_delta_EmoWell_MCMC_both_2var <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                          family = mgcv::betar, seed = seed_no,
                                          iter= niters, weights = num_weights_2var,
                                          covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}

#Posterior Predictive Check (Ppc)
#y_covid_percent_EmoWell_MCMC <- covid_percent$Percent
#yrep_covid_percent_EmoWell_MCMC <- posterior_predict(covid_percent_EmoWell_MCMC, draws = 500) #Broken
y_covid_delta_EmoWell_MCMC <- (covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))$BCovid_Dev

```

We also try to do the same analysis replacing emo_well_being_delta with dass_delta 

```{r}
# correlation plot 
# controlled analysis: adding Covid_Exp1 as covariate
covid_percent <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  #mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) %>% 
  filter(!is.na(BCovid_Dev)) %>% filter(!is.na(emo_well_being_delta)) %>% 
  mutate(T2_DASS_total = T2_DASS_1+T2_DASS_2+T2_DASS_3+T2_DASS_4+T2_DASS_5+T2_DASS_6+
           T2_DASS_7+T2_DASS_8+T2_DASS_9+T2_DASS_10+T2_DASS_11+T2_DASS_12+T2_DASS_13+
           T2_DASS_14+T2_DASS_15+T2_DASS_16+T2_DASS_17+T2_DASS_18+T2_DASS_19+T2_DASS_20+T2_DASS_21,
         T1_DASS_total = T1_DASS_1+T1_DASS_2+T1_DASS21_3_Depression+T1_DASS_4+T1_DASS_5+T1_DASS_6+
           T1_DASS_7+T1_DASS_8+T1_DASS_9+T1_DASS_10+T1_DASS_11+T1_DASS_12+T1_DASS_13+
           T1_DASS_14+T1_DASS_15+T1_DASS_16+T1_DASS_17+T1_DASS_18+T1_DASS_19+T1_DASS_20+T1_DASS_21,
         DASS_delta = T1_DASS_total - T2_DASS_total,
         DASS_delta_z = scale(DASS_delta))

# A couple of regressions were run: 
# - covid_delta_EmoWell_MCMC: Dev ~ Emo_well_being + prev_experience
# - covid_delta_EmoWell_MCMC_both: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weights_3var (the most strict one)
# - covid_delta_EmoWell_MCMC_both_2var: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weight_2var (the most relevant one)
# - with suffix _betareg: for the purpose of posterior_predict 
if (!exists("covid_delta_dass_z_MCMC")) {
covid_delta_dass_z_MCMC <- stan_glm(BCovid_Dev ~ DASS_delta_z + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_dass_z_MCMC_both")) {
covid_delta_dass_z_MCMC_both <- stan_glm(BCovid_Dev ~ DASS_delta_z + twovar_Covid_Exp1 + Covid_Exp2,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}
if (!exists("covid_delta_dass_z_MCMC_both_2var")) {
covid_delta_dass_z_MCMC_both_2var <- stan_glm(BCovid_Dev ~ DASS_delta_z + twovar_Covid_Exp1 + Covid_Exp2,
                                          family = mgcv::betar, seed = seed_no,
                                          iter= niters, weights = num_weights_2var,
                                          covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}

#Posterior Predictive Check (Ppc)
#y_covid_percent_EmoWell_MCMC <- covid_percent$Percent
#yrep_covid_percent_EmoWell_MCMC <- posterior_predict(covid_percent_EmoWell_MCMC, draws = 500) #Broken
y_covid_delta_dass_MCMC <- (covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))$BCovid_Dev

```

The results suggest that there is a positive correlation between delta emo well being and deviance. 

### Covariate

```{r}
# only running covariate model for the first model above
covid_wide <- covid_wide %>% 
    mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))
if (!exists("covid_PCA_MCMC_gender")) {
covid_PCA_MCMC_gender <- stan_glm(emo_well_being_delta ~ T1_Demographics_gender,
                           family = "gaussian",
                           iter= niters_supp, seed=seed_no, data = covid_wide)
}
if (!exists("covid_PCA_MCMC_race")) {
covid_PCA_MCMC_race <- stan_glm(emo_well_being_delta ~ T1_Demographics_race_category,
                           family = "gaussian",
                           iter= niters_supp, seed=seed_no, data = covid_wide)
}
if (!exists("covid_PCA_MCMC_eth")) {
covid_PCA_MCMC_eth <- stan_glm(emo_well_being_delta ~ T1_Demographics_HispanicLatino,
                           family = "gaussian",
                           iter= niters_supp, seed=seed_no, data = covid_wide)
}
if (!exists("covid_PCA_MCMC_ses_country")) {
covid_PCA_MCMC_ses_country <- stan_glm(emo_well_being_delta ~ T1_SES_ladderCountry,
                           family = "gaussian",
                           iter= niters_supp, seed=seed_no, data = covid_wide)
}

covid_PCA_MCMC_gender %>% emmeans(specs = 'T1_Demographics_gender')
covid_PCA_MCMC_race %>% emmeans(specs = 'T1_Demographics_race_category')
covid_PCA_MCMC_eth %>% emmeans(specs = 'T1_Demographics_HispanicLatino')
covid_PCA_MCMC_ses_country %>% describe_posterior()

covid_PCA_MCMC_gender %>% emmeans(specs = 'T1_Demographics_gender') %>% 
  contrast('pairwise')
covid_PCA_MCMC_race %>% emmeans(specs = 'T1_Demographics_race_category') %>% 
  contrast('pairwise')
covid_PCA_MCMC_eth %>% emmeans(specs = 'T1_Demographics_HispanicLatino') %>% 
  contrast('pairwise')


covid_percent <- covid_percent %>%
  mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))
if (!exists("covid_delta_EmoWell_MCMC_gender")) {
covid_delta_EmoWell_MCMC_gender <- stan_glm(BCovid_Dev ~ emo_well_being_delta*T1_Demographics_gender + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters_supp, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_EmoWell_MCMC_race")) {
covid_delta_EmoWell_MCMC_race <- stan_glm(BCovid_Dev ~ emo_well_being_delta*T1_Demographics_race_category + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters_supp, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_EmoWell_MCMC_eth")) {
covid_delta_EmoWell_MCMC_eth <- stan_glm(BCovid_Dev ~ emo_well_being_delta*T1_Demographics_HispanicLatino + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters_supp, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_EmoWell_MCMC_ses_country")) {
covid_delta_EmoWell_MCMC_ses_country <- stan_glm(BCovid_Dev ~ emo_well_being_delta*T1_SES_ladderCountry + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters_supp, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
covid_delta_EmoWell_MCMC_ses_country %>% emtrends(specs  = 'T1_SES_ladderCountry', var  = 'emo_well_being_delta', at = list(T1_SES_ladderCountry = c(ses_mean-ses_std, ses_mean+ses_std)) ) 

covid_delta_EmoWell_MCMC_gender %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_gender') 
covid_delta_EmoWell_MCMC_race %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_race_category')
covid_delta_EmoWell_MCMC_eth %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_HispanicLatino') 

covid_delta_EmoWell_MCMC_gender %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_gender') %>% 
  contrast(list(c(1,-1,0)))

covid_delta_EmoWell_MCMC_race %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_race_category') %>% 
  contrast(list(c(1,-1,0,0,0),
                c(1,0,0,0,-1),
                c(0,1,0,0,-1)))

covid_delta_EmoWell_MCMC_eth %>% emtrends(var = 'emo_well_being_delta', specs = 'T1_Demographics_HispanicLatino') %>% 
  contrast(list(c(1,-1)))

```

# Validity of the avg neg emo metric
Here we provide cronbach alpha for the rating for six negative emotions. 

```{r}
library(psych)
alpha_experienced1 <- nine11_wide %>% dplyr::select(Subject, item, experienced1) %>% 
  pivot_wider(id_cols = Subject, values_from = experienced1, names_from = item) %>% dplyr::select(-Subject) %>% psych::alpha() 
alpha_experienced1$total

alpha_experienced2 <- nine11_wide %>% dplyr::select(Subject, item, experienced2) %>% 
  pivot_wider(id_cols = Subject, values_from = experienced2, names_from = item) %>% dplyr::select(-Subject) %>% psych::alpha() 
alpha_experienced2$total

alpha_remembered2 <- nine11_wide %>% dplyr::select(Subject, item, remembered2) %>% 
  pivot_wider(id_cols = Subject, values_from = remembered2, names_from = item) %>% dplyr::select(-Subject) %>% psych::alpha() 
alpha_remembered2$total
```

We also provide the calculation for omega
```{r}
library(psych)
omega_experienced1 <- nine11_wide %>% dplyr::select(Subject, item, experienced1) %>% 
  pivot_wider(id_cols = Subject, values_from = experienced1, names_from = item) %>% dplyr::select(-Subject) %>% psych::omega() 
omega_experienced1$omega.tot

omega_experienced2 <- nine11_wide %>% dplyr::select(Subject, item, experienced2) %>% 
  pivot_wider(id_cols = Subject, values_from = experienced2, names_from = item) %>% dplyr::select(-Subject) %>% psych::omega() 
omega_experienced2$omega.tot

omega_remembered2 <- nine11_wide %>% dplyr::select(Subject, item, remembered2) %>% 
  pivot_wider(id_cols = Subject, values_from = remembered2, names_from = item) %>% dplyr::select(-Subject) %>% psych::omega() 
omega_remembered2$omega.tot
```


# Save var

```{r}
# the code below was used to save bayesian regression objects
save(MemType_covid_MCMC, MemType_911_MCMC_T2, 
            Dataset_Delta_baseline_MCMC, Rem_covid_MCMC_weighted, Rem_covid_MCMC_unweighted, 
            Rem_911_MCMC_T2_weighted, Rem_911_MCMC_T2_unweighted, 
            covid_PCA_MCMC, covid_delta_EmoWell_MCMC, covid_delta_EmoWell_MCMC_both, covid_delta_EmoWell_MCMC_both_2var, file='BayesRegObj.RData')
sessionInfo()

# another set of code to save all the new models that we have run additionally
#var.save <- c(
#  paste0('MemType_covid_MCMC_covariate_',c('gender','race','eth','ses_country')),
#  paste0('MemType_911_MCMC_T2_',c('gender','race','eth')),
#  'MemType_911_MCMC_T2_discrete',
#  paste0('Rem_covid_MCMC_weighted_',c('gender','race','eth','ses_country')),
#  paste0('Rem_911_MCMC_T2_weighted_',c('gender','race','eth')),
#  Rem_911_MCMC_discrete,
#  paste0('Time_avg_911_MCMC_weighted_',c('gender','race','eth')),
#  StressOTEmo911_MCMC_withprev,
#  paste0('covid_PCA_MCMC_',c('gender','race','eth','ses_country')),
#  paste0('covid_delta_EmoWell_MCMC_',c('gender','race','eth','ses_country')))
save(MemType_covid_MCMC_covariate_gender, MemType_covid_MCMC_covariate_race, MemType_covid_MCMC_covariate_eth, MemType_covid_MCMC_covariate_ses_country,
     MemType_911_MCMC_T2_gender, MemType_911_MCMC_T2_race, MemType_911_MCMC_T2_eth, MemType_911_MCMC_T2_discrete,
     Rem_covid_MCMC_weighted_gender, Rem_covid_MCMC_weighted_race, Rem_covid_MCMC_weighted_eth, Rem_covid_MCMC_weighted_ses_country,
     Rem_911_MCMC_T2_weighted_gender, Rem_911_MCMC_T2_weighted_race, Rem_911_MCMC_T2_weighted_eth, Rem_911_MCMC_discrete,
     Time_avg_911_MCMC_weighted_gender, Time_avg_911_MCMC_weighted_race, Time_avg_911_MCMC_weighted_eth,
     StressOTEmo911_MCMC_withprev, 
     covid_PCA_MCMC_gender, covid_PCA_MCMC_race, covid_PCA_MCMC_eth, covid_PCA_MCMC_ses_country,
     covid_delta_EmoWell_MCMC_gender, covid_delta_EmoWell_MCMC_race, covid_delta_EmoWell_MCMC_eth, covid_delta_EmoWell_MCMC_ses_country, 
     file='BayesRegObj_911Extra.RData')

save(Time_avg_911_MCMC_weighted, Time_avg_911_MCMC_weighted_ref3,
     file='BayesRegObj_911Extra2.RData')
```

```{r}
# ok. now redo all the analysis with just data from the first half 
# change niter to 4000 for a quicker analysis for now
niters <- 4000
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))

#  sanity check: BStress has been beta_squeezed and looks like a beta distribution (that is, fall between 0 and 1)
if (!exists("MemType_covid_MCMC_early")) {
MemType_covid_MCMC_early <- stan_glmer(BStress ~ MemType + (1|Subject), 
                              family = mgcv::betar, iter= niters, seed=seed_no, data = covid_long_type %>% filter(month(T2_Dat) <= 8))
}
if (!exists("MemType_covid_MCMC_late")) {
MemType_covid_MCMC_late <- stan_glmer(BStress ~ MemType + (1|Subject), 
                              family = mgcv::betar, iter= niters, seed=seed_no, data = covid_long_type %>% filter(month(T2_Dat) > 8))
}

MemType_covid_MCMC_early %>% describe_posterior()
MemType_covid_MCMC_late %>% describe_posterior()

covid_percent <- covid_wide %>% mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) 

nine11_percent_T2 <- nine11_long_avg_T2 %>% mutate(Percent = memdev / twovar_prev_experience) %>% filter(!is.na(Percent))

combined_percent_early <- covid_percent %>% 
  filter(month(T2_Dat)<=8) %>% 
  dplyr::select(Subject, Percent, Covid_Dev, twovar_Covid_Exp1, num_weights_2var) %>% 
  rename(dev = Covid_Dev, twovar_prev = twovar_Covid_Exp1, num_weights = num_weights_2var) %>% 
  mutate(Dataset = 'Covid') %>% 
  rbind(
    nine11_percent_T2 %>% dplyr::select(Subject, Percent, memdev, twovar_prev_experience, num_weights_updated) %>% 
      rename(dev = memdev, twovar_prev = twovar_prev_experience, num_weights = num_weights_updated) %>% 
      mutate(Dataset = '911')
  ) %>% 
  mutate(Dataset = relevel(factor(Dataset), ref = 'Covid')) %>% 
  group_by(Dataset) %>% 
  mutate(Bdev = beta_squeeze((dev+4)/8))

combined_percent_late <- covid_percent %>% 
  filter(month(T2_Dat)>8) %>% 
  dplyr::select(Subject, Percent, Covid_Dev, twovar_Covid_Exp1, num_weights_2var) %>% 
  rename(dev = Covid_Dev, twovar_prev = twovar_Covid_Exp1, num_weights = num_weights_2var) %>% 
  mutate(Dataset = 'Covid') %>% 
  rbind(
    nine11_percent_T2 %>% dplyr::select(Subject, Percent, memdev, twovar_prev_experience, num_weights_updated) %>% 
      rename(dev = memdev, twovar_prev = twovar_prev_experience, num_weights = num_weights_updated) %>% 
      mutate(Dataset = '911')
  ) %>% 
  mutate(Dataset = relevel(factor(Dataset), ref = 'Covid')) %>% 
  group_by(Dataset) %>% 
  mutate(Bdev = beta_squeeze((dev+4)/8))

# I still need them together here

if (!exists("Dataset_Delta_baseline_MCMC_early")) {
Dataset_Delta_baseline_MCMC_early <- stan_glm(Bdev ~ Dataset + twovar_prev, family = mgcv::betar, iter= niters, seed=seed_no, data = combined_percent_early) 
}

if (!exists("Dataset_Delta_baseline_MCMC_late")) {
Dataset_Delta_baseline_MCMC_late <- stan_glm(Bdev ~ Dataset + twovar_prev, family = mgcv::betar, iter= niters, seed=seed_no, data = combined_percent_late) 
}

describe_posterior(Dataset_Delta_baseline_MCMC_early) # more overestimation for 9-11
describe_posterior(Dataset_Delta_baseline_MCMC_late) # more overestimation for 9-11

###
covid_BRem <- covid_wide %>% mutate(BCovid_Rem = beta_squeeze((Covid_Rem-1)/4)) %>% 
  filter(!is.na(BCovid_Rem)) %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)) %>% 
  mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))
if (!exists("Rem_covid_MCMC_weighted_early")) {
Rem_covid_MCMC_weighted_early <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem %>% filter(month(T2_Dat)<=8))
}

if (!exists("Rem_covid_MCMC_weighted_late")) {
Rem_covid_MCMC_weighted_late <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem %>% filter(month(T2_Dat)>8))
}


describe_posterior(Rem_covid_MCMC_weighted_early)
describe_posterior(Rem_covid_MCMC_weighted_late) # this result is actually different from before!

covid_percent <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  #mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) %>% 
  filter(!is.na(BCovid_Dev)) %>% filter(!is.na(emo_well_being_delta))
if (!exists("covid_delta_EmoWell_MCMC_early")) {
covid_delta_EmoWell_MCMC_early <- stan_glm(BCovid_Dev ~ emo_well_being_delta + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(month(T2_Dat)<=8))
}
if (!exists("covid_delta_EmoWell_MCMC_late")) {
covid_delta_EmoWell_MCMC_late <- stan_glm(BCovid_Dev ~ emo_well_being_delta + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(month(T2_Dat)>8))
}
if (!exists("covid_delta_EmoWell_MCMC_both_early")) {
covid_delta_EmoWell_MCMC_both_early <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)) %>% filter(month(T2_Dat)<=8))
}
if (!exists("covid_delta_EmoWell_MCMC_both_late")) {
covid_delta_EmoWell_MCMC_both_late <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)) %>% filter(month(T2_Dat)>8))
}

# what if we are only looking at data collected in May vs. in November?
t.test(covid_wide$Covid_Exp1[month(covid_wide$T2_Dat)==5],
       covid_wide$Covid_Exp1[month(covid_wide$T2_Dat)==11])
# there is no difference in their initial report stress experience
# a lot of ppl in November do not have DASS score - also I dont think we need to report that our sample  
t.test(covid_wide$Covid_Exp2[month(covid_wide$T2_Dat)==5],
       covid_wide$Covid_Exp2[month(covid_wide$T2_Dat)==11])
t.test(covid_wide$Covid_Rem[month(covid_wide$T2_Dat)==5],
       covid_wide$Covid_Rem[month(covid_wide$T2_Dat)==11])

```

```{r}
# trying to run analysis to tease apart subjective and objective stress measure
# what are our columns reflecting objective? 
# Let's probably just look at the covid one for now since this is what we are familiar with (also what they ask for)
covid_wide <- covid_wide %>% 
  mutate(personal_loss = case_when(T2_Q33 == "No" ~ 0,
                                   T2_Q33 == "Yes" ~ 1,
                                   .default = NA),
         finance_loss = case_when(T2_Q34 == "No" ~ 0,
                                   T2_Q34 == "Yes" ~ 1,
                                   .default = NA),
         finance_loss_level = case_when(str_detect(T2_Q35, 'Minimal') ~ 1,
                                        str_detect(T2_Q35, 'Moderate') ~ 2,
                                        str_detect(T2_Q35, 'Severe') ~ 3,
                                        str_detect(T2_Q35, 'Devastating') ~ 4,
                                        .default = 0),
         finance_loss_cont = finance_loss * finance_loss_level)

covid_percent_new <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  mutate(BCovid_Diff = beta_squeeze((Covid_Exp2-Covid_Exp1+4)/8)) %>% 
  mutate(BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4)) %>% 
  filter(!is.na(BCovid_Dev)) %>% 
  filter(!is.na(BCovid_Diff)) 

# if they become worse in the process, will they overestimate?

test1.T2 <- stan_glm(BCovid_Exp2 ~ personal_loss + finance_loss,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters,
                                     covid_percent_new)

test1 <- stan_glm(BCovid_Diff ~ personal_loss + finance_loss_cont + Covid_Exp1,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent_new)

test2 <- stan_glm(BCovid_Dev ~ personal_loss + finance_loss_cont + Covid_Exp1 + emo_well_being_delta,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent_new)
test %>% describe_posterior()
Covid_Dev ~ personal_loss + finance_loss_cont
```











