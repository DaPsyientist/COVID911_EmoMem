---
title: "Bayesian Regression Results for Covid Project"
output: 
  rmarkdown::github_document:
    toc: true
    #toc_float: true
    toc_depth: 4
---

This is an R markdown file to run the Regression Analysis for manuscript 'Overestimating the intensity of negative emotion in autobiographical memory: evidence from the 9/11 attack and Covid-19 pandemic'

For plotting, please see the Plot_notebook.Rmd

Besides providing the data files needed to run the analysis, we have also provided a saved rds file storing all the MCMC objects. You could download it from OSF [OSF link] and place it in the data folder

For any question, contact Haoxue (haoxue_fan@g.harvard.edu) or Johnny (jcastillo@g.harvard.edu)

```{r load dependency and datafile, include=FALSE}
# source some helper functions
source('utils.R')
# read in data
# if you wish to load in the saved RData file, uncomment the line below
#load(file = '../data/BayesRegObj.RData')
covid_wide <-  read.csv('../data/Complete_test_Dev_Exp_Only_Data_Manipulation.csv') #each row is one observation, T1 and T2 separated by prefix in the column
nine11_long_avg <- read.csv('../data/df.emo.long.avg_Only_Data_Manipulation.csv') #each row is one observation at one time point, stress_memory is avg across emotions

#  filter time2 data frome 911 to do shared analysis 
nine11_long_avg_T2 <- nine11_long_avg %>% filter(time==2)

## define var related to MCMC
niters <- 40000
seed_no <- 1636
```

# Demographic

## Covid

```{r demo}
covid_wide$T1_Demographics_gender %>% table(useNA='ifany')
covid_wide$T1_Demographics_race %>% table(useNA = 'ifany')
covid_wide$T1_Demographics_HispanicLatino %>% table(useNA = 'ifany')
```

## 911

```{r}
df.emo.demo <- read.csv('../data/df.911.demo.csv')

nine11_long_avg_T2.demo <- nine11_long_avg_T2 %>% filter(!is.na(prev_experience) & !is.na(curr_experience)) %>% left_join(df.emo.demo) 
nine11_long_avg_T2.demo$gender %>% table(useNA = 'ifany')
c(nine11_long_avg_T2.demo$age %>% mean(na.rm=T), nine11_long_avg_T2.demo$age %>% var(na.rm=T) %>% sqrt)
nine11_long_avg_T2.demo$race_1 %>% table(useNA = 'ifany')

nine11_long_avg.demo <- nine11_long_avg %>% filter(!is.na(memdev) & !is.na(prev_experience)) %>% left_join(df.emo.demo) %>% group_by(Subject) %>% slice(1)
nine11_long_avg.demo$gender %>% table(useNA = 'ifany')
c(nine11_long_avg.demo$age %>% mean(na.rm=T), nine11_long_avg.demo$age %>% var(na.rm=T) %>% sqrt)
nine11_long_avg.demo$race_1 %>% table(useNA = 'ifany')
```

# Stress (NegEmo) ~ type (T1_experienced/T2_remembered/T2_experienced)

This analysis answers the q: Does T1_experienced / T2_remembered / T2_experienced differ from each other? 

## Covid
```{r }
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))
n_ppt <- length(unique(covid_long_type$Subject)) #Calculate number of participants; 726
covid_long_type %>% group_by(MemType) %>% 
  summarise(mean=mean(BStress, na.rm=T), se=sd(BStress, na.rm=T)/sqrt(n_ppt))

#  sanity check: BStress has been beta_squeezed and looks like a beta distribution (that is, fall between 0 and 1)
covid_long_type %>% ggplot(aes(x=BStress)) + geom_histogram(bins = 20) + facet_wrap(~MemType)
if (!exists("MemType_covid_MCMC")) {
MemType_covid_MCMC <- stan_glmer(BStress ~ MemType + (1|Subject), 
                              family = mgcv::betar, iter= niters, seed=seed_no, data = covid_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_covid_MCMC<- covid_long_type$BStress
yrep_y_MemType_covid_MCMC <- posterior_predict(MemType_covid_MCMC, draws = 500)
#Summarize Posterior
plot_model(MemType_covid_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_covid_MCMC)
```

People's T2_experienced covid stress is smaller than T1_experienced, while T2_remembered is higher than T1_experienced.

[Haoxue: not sure how to deal with the words below yet.]
Note that in the plot above (and the model) the DVs have been beta transformed.

If we want to see the results on its original scale, we will need to run the same analysis but this time possibly use a beta linear mixed regrsssion.

## 911

To provide a fair comparison between Covid and 911, we focused on 911 survey 2 results (that is, the 1 year follow-up survey)

```{r}
nine11_long_type <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))
 #Number of 911 participants in case we also need it for SE
n_911_ppt <- length(unique(nine11_long_type$Subject)) #Calculate number of participants; 1430

#   sanity check: BNegEmo has been beta_squeezed
nine11_long_type %>% ggplot(aes(x=BNegEmo)) + geom_histogram(bins = 20) + facet_wrap(~MemType) # may worth noting that sanity check result for covid and 911 looks different
if (!exists("MemType_911_MCMC_T2")) {
MemType_911_MCMC_T2 <- stan_glmer(BNegEmo ~ MemType + (1|Subject), 
                                family = mgcv::betar, iter= niters, seed=seed_no,
                                data = nine11_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_911_MCMC_T2<- nine11_long_type$BNegEmo
yrep_MemType_911_MCMC_T2 <- posterior_predict(MemType_911_MCMC_T2, draws = 500)
#Summarize Posterior
plot_model(MemType_911_MCMC_T2, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_911_MCMC_T2)

```

# Deviance  ~ Dataset (Covid/911_T2) + T1_experienced

In this analysis, we aim to compare whether people's degree of deviance differ between Covid and 9/11 data.

Because the range of response differs between two dataset, we use Deviance (transformed into Beta) as DV and use the data type and T1_experienced to predict it. 

A quick note that the reason that we moved away from percent is because that the meaning of a ratio is that the same magnitude of change means differently when the baseline is different. However, this is not what we mean here. Therefore, we decide to focus on the raw deviance score while controlling for baseline by including T1_experienced on the right hand side. We apologzie for the potential confusion caused by the fact that we still call the dataset covid_percent.. but our actual DV is the deviance score, not the percent.

Another quick note for the model specification: there is no random effect because each subject either contribute to the covid or the 9/11 dataset, but not both

```{r, include = FALSE}
# code in this chunk was related to percent, keep it here for now.
covid_percent <- covid_wide %>% mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) 
nine11_percent_T2 <- nine11_long_avg_T2 %>% mutate(Percent = memdev / twovar_prev_experience) %>% filter(!is.na(Percent))
combined_percent <- covid_percent %>% dplyr::select(Subject, Percent, Covid_Dev, twovar_Covid_Exp1, num_weights_2var) %>% 
  rename(dev = Covid_Dev, twovar_prev = twovar_Covid_Exp1, num_weights = num_weights_2var) %>% 
  mutate(Dataset = 'Covid') %>% 
  rbind(
    nine11_percent_T2 %>% dplyr::select(Subject, Percent, memdev, twovar_prev_experience, num_weights_updated) %>% 
      rename(dev = memdev, twovar_prev = twovar_prev_experience, num_weights = num_weights_updated) %>% 
      mutate(Dataset = '911')
  ) %>% 
  mutate(Dataset = relevel(factor(Dataset), ref = 'Covid')) %>% 
  group_by(Dataset) %>% 
  mutate(Bdev = beta_squeeze((dev+4)/8))

# sanity check: Percent looks like Gaussian
combined_percent %>% ggplot(aes(x=Percent)) + geom_histogram(bins = 100) + facet_wrap(~Dataset)

if (!exists("Dataset_Delta_baseline_MCMC")) {
Dataset_Delta_baseline_MCMC <- stan_glm(Bdev ~ Dataset + twovar_prev, family = mgcv::betar, iter= niters, seed=seed_no, data = combined_percent) 
}

#Posterior Predictive Check (Ppc)
y_Dataset_Delta_baseline_MCMC <- combined_percent$Bdev
#Summarize Posterior
plot_model(Dataset_Delta_baseline_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red") 
#emmeans(Dataset_Delta_baseline_MCMC, specs = 'Dataset') 
plot_model(Dataset_Delta_baseline_MCMC, terms= c('(Intercept)','Dataset911','twovar_prev')) + theme_sjplot()# any way to remove phi?; yes! done
# a different way to show the coefficient
mcmc_intervals(as.array(Dataset_Delta_baseline_MCMC), pars = c('(Intercept)','Dataset911','twovar_prev'))
describe_posterior(Dataset_Delta_baseline_MCMC) # more overestimation for 9-11
```
Interpretation of the results: after controlling for T1_experienced stress/negemo, people tend to overestimate more when recalling 9/11 negative emotion compared to covid-related stress.

# Rem ~ Exp1 + Exp2

Here, we ask the q: how does people reconstruct remembered stress/negemo? We suspect that besides the 'ground truth' T1_experienced, people's current stress will also play a role. Similar to previous analysis, Rem was converted to follow beta distribution. Also, the model specification does not include random effect.

## Covid
```{r}
covid_BRem <- covid_wide %>% mutate(BCovid_Rem = beta_squeeze((Covid_Rem-1)/4)) %>% 
  filter(!is.na(BCovid_Rem)) %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2))
if (!exists("Rem_covid_MCMC_weighted")) {
Rem_covid_MCMC_weighted <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}


#Posterior Predictive Check (Ppc)
y_Rem_covid_MCMC_weighted <- covid_BRem$BCovid_Rem
#Summarize Posterior
#plot_model(Rem_covid_MCMC_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_covid_MCMC_weighted)
mcmc_intervals(as.array(Rem_covid_MCMC_weighted), pars = c('(Intercept)','Covid_Exp1','Covid_Exp2'))

# conduct the same analysis w/n weight specification - results are consistent
if (!exists("Rem_covid_MCMC_unweighted")) {
Rem_covid_MCMC_unweighted <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                    family = mgcv::betar, iter= niters, seed = seed_no,
                                    data = covid_BRem)
}
#plot_model(Rem_covid_MCMC_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
mcmc_intervals(as.array(Rem_covid_MCMC_unweighted), pars = c('(Intercept)','Covid_Exp1','Covid_Exp2'))
describe_posterior(Rem_covid_MCMC_unweighted)
```

When recalling covid-related stress, both current and prev stress influenced remembered stress, with prev stress inserts a larger influence.

## 911
```{r}
nine11_BRem_T2 <- nine11_long_avg_T2 %>% mutate(B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  filter(!is.na(B911_Rem)) %>% filter(!is.na(prev_experience)) %>% filter(!is.na(curr_experience))
if (!exists("Rem_911_MCMC_T2_weighted")) {
Rem_911_MCMC_T2_weighted <- stan_glm(B911_Rem ~ prev_experience + curr_experience,
                                    family = mgcv::betar, iter= niters, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)
}
#Posterior Predictive Check (Ppc)
y_Rem_911_MCMC_T2_weighted <- nine11_BRem_T2$B911_Rem

#Summarize Posterior
#plot_model(Rem_911_MCMC_T2_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_911_MCMC_T2_weighted)

# without weight specification the results are consistent
if (!exists("Rem_911_MCMC_T2_unweighted")) {
Rem_911_MCMC_T2_unweighted <- stan_glm(B911_Rem ~ prev_experience + curr_experience,
                                     family = mgcv::betar, iter= niters, seed=seed_no,
                                     data = nine11_BRem_T2)
}
plot_model(Rem_911_MCMC_T2_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Rem_911_MCMC_T2_unweighted)
mcmc_intervals(as.array(Rem_911_MCMC_T2_unweighted), pars = c('(Intercept)','prev_experience','curr_experience'))
```

# Dev ~ MemTime + prev_experience

Using the 9/11 dataset, we test whether the deviation is a function of Time.
```{r}
nine11_percent <- nine11_long_avg %>% 
  #mutate(Percent = memdev / twovar_prev_experience) %>% 
  mutate(Bdev = (memdev+4)/8) %>% 
  mutate(time = relevel(factor(time), ref='2')) %>% 
  #filter(!is.na(Percent))
  filter(!is.na(Bdev)) %>% 
  filter(!is.na(prev_experience))


# note: the original data stored in the .rda is wrong. it was operated on percent, while we are actually interested in the raw deviation

if (!exists("Time_avg_911_MCMC_weighted")) {
Time_avg_911_MCMC_weighted <- stan_glmer(Bdev ~ time + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters, 
                             weights = num_weights_updated, seed = seed_no,
                             data = nine11_percent)
}
#Posterior Predictive Check (Ppc)
y_Time_avg_911_MCMC_weighted <- nine11_percent$Bdev
yrep_Time_avg_911_MCMC_weighted <- posterior_predict(Time_avg_911_MCMC_weighted, draws = 500)
#Summarize Posterior
plot_model(Time_avg_911_MCMC_weighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(Time_avg_911_MCMC_weighted)

Time_avg_911_MCMC_unweighted_percent <- Time_avg_911_MCMC_unweighted
# remember to save it afterwards! 
if (!exists("Time_avg_911_MCMC_unweighted")) {
Time_avg_911_MCMC_unweighted <- stan_glmer(Bdev ~ time + prev_experience + (1|Subject), 
                             family = mgcv::betar, iter= niters, 
                             seed = seed_no,
                             data = nine11_percent)
}
plot_model(Time_avg_911_MCMC_unweighted, type = "pred", ci.lvl = .95, bpe.color = "red") 
#Posterior Predictive Check (Ppc)
y_Time_avg_911_MCMC_unweighted <- nine11_percent$Bdev
yrep_Time_avg_911_MCMC_unweighted <- posterior_predict(Time_avg_911_MCMC_unweighted, draws = 500) 
very little
#Summarize Posterior
describe_posterior(Time_avg_911_MCMC_unweighted)

```
People overestimate neg emo more at 3-year follow-up than at 1-year and 10-years follow-up. There is no difference between the deviation of negative emotion recalled at 1-year and 10-years follow-up. 


# Separate Analysis (covid): Overestimation ~ Delta Emotion Well-being

Finally, we use Covid dataset and see whether there is any association between delta emotion well-being and deviation.


```{r}
# sanity check: people's emotion well being becomes better from T1 to T2.
if (!exists("covid_PCA_MCMC")) {
covid_PCA_MCMC <- stan_glm(emo_well_being_delta ~ 1,
                           family = "gaussian",
                           iter= niters, seed=seed_no, data = covid_wide)
}
#Posterior Predictive Check (Ppc)
y_covid_PCA_MCMC <- covid_wide %>% filter(emo_well_being_delta != "NA") %>% dplyr::select(emo_well_being_delta)
y_covid_PCA_MCMC <- y_covid_PCA_MCMC$emo_well_being_delta
yrep_covid_PCA_MCMC <- posterior_predict(covid_PCA_MCMC, draws = 500) #Good, but less peaked then the data
#Summarize Posterior
plot_model(covid_PCA_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red") 
describe_posterior(covid_PCA_MCMC)
```

```{r}
# controlled analysis: adding Covid_Exp1 as covariate
covid_percent <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  #mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) %>% 
  filter(!is.na(BCovid_Dev)) %>% filter(!is.na(emo_well_being_delta))
# A couple of regressions were run: 
# - covid_delta_EmoWell_MCMC: Dev ~ Emo_well_being + prev_experience
# - covid_delta_EmoWell_MCMC_both: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weights_3var (the most strict one)
# - covid_delta_EmoWell_MCMC_both_2var: Dev ~ Emo_well_being + prev_experience + curr_experience, weight=weight_2var (the most relevant one)
# - with suffix _betareg: for the purpose of posterior_predict 
if (!exists("covid_delta_EmoWell_MCMC")) {
covid_delta_EmoWell_MCMC <- stan_glm(BCovid_Dev ~ emo_well_being_delta + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
if (!exists("covid_delta_EmoWell_MCMC_both")) {
covid_delta_EmoWell_MCMC_both <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                     family = mgcv::betar, seed = seed_no,
                                     iter= niters, weights = num_weights_3var,
                                     covid_percent %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}
if (!exists("covid_delta_EmoWell_MCMC_both_2var")) {
covid_delta_EmoWell_MCMC_both_2var <- stan_glm(BCovid_Dev ~ emo_well_being_delta + twovar_Covid_Exp1 + Covid_Exp2,
                                          family = mgcv::betar, seed = seed_no,
                                          iter= niters, weights = num_weights_2var,
                                          covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))
}

#Posterior Predictive Check (Ppc)
#y_covid_percent_EmoWell_MCMC <- covid_percent$Percent
#yrep_covid_percent_EmoWell_MCMC <- posterior_predict(covid_percent_EmoWell_MCMC, draws = 500) #Broken
y_covid_delta_EmoWell_MCMC <- (covid_percent %>% filter(!is.na(twovar_Covid_Exp1)) %>% filter(!is.na(Covid_Exp2)))$BCovid_Dev

```

The results suggest that there is a positive correlation between delta emo well being and deviance. 
```{r}
# the code below was used to save bayesian regression objects
save(MemType_covid_MCMC, MemType_911_MCMC_T2, 
            Dataset_Delta_baseline_MCMC, Rem_covid_MCMC_weighted, Rem_covid_MCMC_unweighted, 
            Rem_911_MCMC_T2_weighted, Rem_911_MCMC_T2_unweighted, 
            covid_PCA_MCMC, covid_delta_EmoWell_MCMC, covid_delta_EmoWell_MCMC_both, covid_delta_EmoWell_MCMC_both_2var, file='BayesRegObj.RData')
sessionInfo()
```













