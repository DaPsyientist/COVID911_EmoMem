---
title: "Plot and Descriptive Stats for Covid Project"
output: 
  rmarkdown::github_document:
    toc: true
    #toc_float: true
    toc_depth: 4
---

This is an R Markdown file to reproduce figures in manuscript 'Overestimating the intensity of negative emotion in autobiographical memory: evidence from the 9/11 attack and Covid-19 pandemic'

For regression analysis, please see MCMC_analyses_notebook.Rmd

Besides providing the data files needed to run the analysis, we have also provided a saved rds file storing all the MCMC objects. You could download it from OSF [OSF link] and place it in the data folder

For any question, contact Haoxue (haoxue_fan@g.harvard.edu) or Johnny (jcastillo@g.harvard.edu)

```{r load dependency and datafile, include=FALSE}
source('utils.R')
# here we need to use one of the regression object to generate predictions. 
# if you wish to load in the saved RData file, uncomment the line below
load(file = '../data/BayesRegObj.RData')
load(file= '../data/BayesRegObj_911Extra.RData')

# read in data
covid_wide <-  read.csv('../data/Complete_test_Dev_Exp_Only_Data_Manipulation.csv') %>% #each row is one observation, T1 and T2 separated by prefix in the column
      mutate(T1_Demographics_race_category = case_when(T1_Demographics_race == 'White/Caucasian' ~ 'White',
                                                   T1_Demographics_race == 'Black/African American' ~ 'Black',
                                                   T1_Demographics_race == 'Asian' ~ 'Asian',
                                                   is.na(T1_Demographics_race) ~ 'Other',
                                                   TRUE ~ 'Mixed'))

df.emo.demo <- read.csv('../data/df.911.demo.csv')

nine11_long_avg <- read.csv('../data/df.emo.long.avg_Only_Data_Manipulation.csv') #each row is one observation at one time 
nine11_long_avg.demo <- nine11_long_avg %>% filter(!is.na(memdev) & !is.na(prev_experience)) %>% left_join(df.emo.demo) %>% group_by(Subject) %>% slice(1)

nine11_wide_avg <- read.csv('../data/df.emo.wide.avg_Only_Data_Manipulation.csv') %>% #each row is one observation at one time point, stress_memory is avg across emotions
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

nine11_long_avg.demo <- nine11_long_avg %>% filter(!is.na(memdev) & !is.na(prev_experience)) %>% left_join(df.emo.demo) %>% group_by(Subject) %>% slice(1)

nine11_wide <- read.csv('../data/df.emo.wide_Only_Data_Manipulation.csv') %>% #each row is one observation at one time point, stress_memory is specific to one emotion
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

nine11_long_avg <- read.csv('../data/df.emo.long.avg_Only_Data_Manipulation.csv') %>% #each row is one observation at one time point, stress_memory is avg across emotions
  left_join(nine11_long_avg.demo %>% dplyr::select(Subject, age, gender, race_1, origin_1)) %>% 
  rename(race=race_1, origin=origin_1) %>% mutate(race_category = case_when(race == 'White' ~ 'White',
                                                                          race == 'Black' ~ 'Black',
                                                                          race == 'Asian' | race == 'East Indian' ~ 'Asian',
                                                                          TRUE ~ 'Other Or NA'),
                                                  eth_category = case_when(race == 'Hispanic' ~ 'Hispanic', TRUE ~ 'Other Or NA'))

#  filter time2 data frome 911 to do shared analysis 
nine11_long_avg_T2 <- nine11_long_avg %>% filter(time==2)
nine11_wide_T2 <- nine11_wide %>% dplyr::select(!ends_with('3') & !ends_with('4'))
```

# Supplementary Fig1 : Time interval between the initial and the follow-up questionnaire filled out date for the Covid-19 dataset

```{r delta time}
# delta time
covid_wide$Dat_Delta <- as.Date(covid_wide$T2_StartDate) - as.Date(covid_wide$T2_Dat)
mean(covid_wide$Dat_Delta)
sqrt(var(covid_wide$Dat_Delta))

covid_wide %>% ggplot(aes(x=as.double(Dat_Delta))) +
   geom_histogram(color='black') +
   xlab('T2-T1 (days)') +
  emomem_theme

ggsave('../Output/fig/pdf/Supp_delta_date.pdf', height=6, width=8)
ggsave('../Output/fig/png/Supp_delta_date.png', height=6, width=8)
```


We also provide a graph on when (which month) participants have entered the experiment (T1)

```{r}
covid_wide %>% 
  ggplot(aes(x=month(T2_Dat))) + 
  geom_histogram(color='black')+
  xlab('month')+
  scale_x_continuous(breaks=c(4:12))+
  emomem_theme
# what is the proportion of people at T1 is before Aug?
covid_wide$T2_Month <- month(covid_wide$T2_Dat)
sum(covid_wide$T2_Month<=8) / nrow(covid_wide)
sum(covid_wide$T2_Month==11) / nrow(covid_wide)
```

# Supplementary Table 9 for Covid related stressors
```{r}
T1_covid_header <- read.csv('../data-raw/COVIDdata_vertical_new_q.csv')
T1_covid_item <- T1_covid_header %>% filter(str_detect(Header, 'lifechanges'))
T1_covid_item %>% mutate(Item = str_replace(Item, 'How much stress are you experiencing right now as a result of...', '')) %>% dplyr::select(Item) %>% rename(`How much stress are you experiencing right now as a result of...`=Item) %>% 
  as.data.frame %>% write.csv('../Output/csv/Supp_T1_covid_item.csv')
```

# Supplementary Table 10. Loading Matrix for PCA
```{r PCA Loading Matrix}

df.prev_pca <- covid_wide %>% dplyr::select(T2_prolific_mturk_ID, starts_with('T1_PSS') & !contains('total'), starts_with('T1_DASS') & !contains('total')) %>% na.omit 
prev_pca <- df.prev_pca %>% dplyr::select(-T2_prolific_mturk_ID) %>% 
  prcomp(center=TRUE, scale. =TRUE)

df.curr_pca <- covid_wide %>% dplyr::select(T2_prolific_mturk_ID, 
                                   starts_with('T2_PSS') & !contains('total'), 
                                   starts_with('T2_DASS') & !contains('total')) %>% 
  na.omit %>% 
  mutate(T2_PSS_4=4-T2_PSS_4, T2_PSS_5=4-T2_PSS_5, T2_PSS_7=4-T2_PSS_7, T2_PSS_8=4-T2_PSS_8) %>% 
  set_colnames(colnames(df.prev_pca))

df.prev_pca$prev_pca_score <- (prev_pca$x[,1]) * (-1)
df.curr_pca$curr_pca_score <- ((prev_pca %>% predict(df.curr_pca %>% dplyr::select(-T2_prolific_mturk_ID)))[,1]) * (-1)

# loading matrix
loading.prev_pca <- data.frame(Loading = prev_pca$rotation[,1]) %>% rownames_to_column(var='T1_Scale_Item') %>% 
  mutate(Scale = str_extract(T1_Scale_Item, 'PSS|DASS'), Index = str_extract(T1_Scale_Item, '(?<=_)[0-9]+'))
loading_header.prev_pca <- T1_covid_header %>% filter(str_detect(Header,'PSS_') | str_detect(Header, 'DASS21_')) %>% 
  mutate(Scale = str_extract(Header, 'PSS|DASS'), Index = str_extract(Header, '(?<=_)[0-9]+')) 
loading.prev_pca %>% merge(loading_header.prev_pca, by = c('Scale','Index')) %>% dplyr::select(Scale, Item, Loading) %>% 
  mutate(Loading = round(Loading, 3)) %>% 
  write.csv('../Output/csv/Supp_PCA_loading.csv')

```

# Supplementary Table 11 Correlation between subjective well-being score and psychological scales
```{r correlate with subscale}
covid_wide <- covid_wide %>% 
  mutate(T1_PSS_total = rowSums(covid_wide %>% dplyr::select(T1_PSS_1:T1_PSS_10)),
         T2_PSS_total = T2_PSS_1 + T2_PSS_2 + T2_PSS_3 + 4 - T2_PSS_4 + 4 - T2_PSS_5 + T2_PSS_6 + 4 - T2_PSS_7 + 4 - T2_PSS_8 + T2_PSS_9 + T2_PSS_10,
         T1_DASS_total_S = T1_DASS_1 + T1_DASS_6 + T1_DASS_8 + T1_DASS_11 + T1_DASS_12 + T1_DASS_14 + T1_DASS_18,
         T1_DASS_total_A = T1_DASS_2 + T1_DASS_4 + T1_DASS_7 + T1_DASS_9 + T1_DASS_15 + T1_DASS_19 + T1_DASS_20,
         T1_DASS_total_D = T1_DASS21_3_Depression + T1_DASS_5 + T1_DASS_13 +T1_DASS_16 + T1_DASS_17 + T1_DASS_21,
         T2_DASS_total_S = T2_DASS_1 + T2_DASS_6 + T2_DASS_8 + T2_DASS_11 + T2_DASS_12 + T2_DASS_14 + T2_DASS_18,
T2_DASS_total_A = T2_DASS_2 + T2_DASS_4 + T2_DASS_7 + T2_DASS_9 + T2_DASS_15 + T2_DASS_19 + T2_DASS_20,
T2_DASS_total_D = T2_DASS_3 + T2_DASS_5 + T2_DASS_13 +T2_DASS_16 + T2_DASS_17 + T2_DASS_21,
neg_PCA_T1 = -PCA_T1,
neg_PCA_T2 = -PCA_T2
           )

r_pca <- covid_wide %>% dplyr::select(neg_PCA_T1, neg_PCA_T2, T1_PSS_total, T1_DASS_total_A, T1_DASS_total_D, T1_DASS_total_S, 
                      T2_PSS_total, T2_DASS_total_A, T2_DASS_total_D, T2_DASS_total_S) %>% as.matrix() %>% 
  rcorr()
r_pca_rowname <- c('T1 Subjective Well-being', 'T2 Subjective Well-being', 'T1 PSS', 'T1 DASS Anxiety', 'T1 DASS Depression', 'T1 DASS Stress','T2 PSS', 'T2 DASS Anxiety', 'T2 DASS Depression', 'T2 DASS Stress' )
r_pca$r[,1:2] %>% round(3) %>% 
  set_rownames(r_pca_rowname) %>% 
  set_colnames(r_pca_rowname[1:2]) %>% 
  write.csv('../Output/csv/r_pca.csv')

```
We also examine the correlation between the subjective well-being score and T1/T2 covid stress score

```{r}
# rearrange the order of the scales to provide a better visual
r_pca_extended <- covid_wide %>% dplyr::select(neg_PCA_T1, neg_PCA_T2, T1_PSS_total, 
                                               T2_PSS_total,
                                               T1_DASS_total_A, T1_DASS_total_D, T1_DASS_total_S, 
                      T2_DASS_total_A, T2_DASS_total_D, T2_DASS_total_S, Covid_Exp1, Covid_Exp2, Covid_Rem) %>% as.matrix() %>% 
  rcorr()
r_pca_extended_rowname <- c('T1 Subjective Well-being', 'T2 Subjective Well-being', 'T1 PSS', 
                            'T2 PSS',
                            'T1 DASS Anxiety', 'T1 DASS Depression', 'T1 DASS Stress',
                            'T2 DASS Anxiety', 'T2 DASS Depression', 'T2 DASS Stress', 'Covid Stress T1 Experienced', 'Covid Stress T2 Experienced', 'Covid Stress Remembered')
r_pca_extended$r[,1:4] %>% round(3) %>% 
  set_rownames(r_pca_extended_rowname) %>% 
  set_colnames(r_pca_extended_rowname[1:4])
```


# Figure 1
```{r Figure 1}

# Fig 1A
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))
# though I did all the trick here, but it may worth noting that the final graph only include the untransformed y (on the scale between 1 to 5)
covid_long_type_plot <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('Covid_Exp1','Covid_Exp2','Covid_Rem'),
               names_to = 'MemType', values_to = 'Stress') %>% 
  mutate(MemType = factor(MemType, levels = c('Covid_Exp1','Covid_Exp2','Covid_Rem'),
                          labels = c('Previous ', 'Current ', 'Remembered'))) %>% 
  filter(!is.na(Stress))

fig1A <- covid_long_type_plot %>% ggplot(aes(x = MemType, y = Stress)) + 
  stat_summary(size=1.7) 

fig1A + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') 
ggsave('../Output/fig/pdf/fig_stress_compare_new_ylab.pdf',height=6,width=7)
ggsave('../Output/fig/png/fig_stress_compare_new_ylab.png',height=6,width=7)

# Fig 1B
nine11_long_type <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))

nine11_long_type_plot <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('prev_experience', 'curr_experience','stress_memory'),
               names_to = 'MemType', values_to = 'NegEmo') %>% 
  mutate(MemType = factor(MemType, levels = c('prev_experience','curr_experience','stress_memory'),
                          labels = c('Previous ', 'Current ', 'Remembered'))) %>% 
  filter(!is.na(NegEmo))

fig1B <- nine11_long_type_plot %>% ggplot(aes(x = MemType, y = NegEmo)) + 
  stat_summary(size=1.2)
fig1B + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') 
ggsave('../Output/fig/pdf/fig_negemo_compare_new_ylab.pdf',height=6,width=7)
ggsave('../Output/fig/png/fig_negemo_compare_new_ylab.png',height=6,width=7)
  
```
We also provide a graph to comapre previous, current and remembered covid-related stress in May (early data collection) and November (late data collection)

```{r}
covid_long_type_plot %>% 
  filter(month(T2_Dat)==5|month(T2_Dat)==11) %>% 
  mutate(month=factor(month(T2_Dat))) %>% 
  ggplot(aes(x = MemType, y = Stress, group = month, color = month)) + 
  stat_summary(size=1.7, position=position_dodge(width=0.9)) +
  emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') 
ggsave('../Output/fig/pdf/revision_fig_stress_compare_month.pdf',height=6,width=7)
ggsave('../Output/fig/png/revision_fig_stress_compare_month.png',height=6,width=7)

```

# Figure 2
## Figure 2A, 2C
```{r Fig 2}
# Fig 2A

# because we want y to be on its original scale, we need to extract the data and can not use plot_model_IVs_stan wrapper

covid_BRem <- covid_wide %>% mutate(BCovid_Rem = beta_squeeze((Covid_Rem-1)/4)) %>% 
  filter(!is.na(BCovid_Rem)) %>% filter(!is.na(Covid_Exp1)) %>% filter(!is.na(Covid_Exp2))
if (!exists("Rem_covid_MCMC_weighted")) {
Rem_covid_MCMC_weighted <- stan_glm(BCovid_Rem ~ Covid_Exp1 + Covid_Exp2,
                                  family = mgcv::betar, iter= niters, 
                           weights = num_weights_3var, seed = seed_no, data = covid_BRem)
}

df_Rem_covid_MCMC_weighted <- Rem_covid_MCMC_weighted %>% plot_model_IVs_stan(variable_array = c('Covid_Exp1','Covid_Exp2'),
                                              x_range = seq(1,5,by=0.2), return_df = TRUE) %>% as.data.frame
df_Rem_covid_MCMC_weighted <- df_Rem_covid_MCMC_weighted %>% mutate(
  across(!starts_with("x"), 
         function(x){return(reverse_beta_squeeze(x, n= length(covid_BRem$BCovid_Rem), likert_min_max = c(1,5)))},
         .names = "{.col}_original"))
 

p_Rem_covid_MCMC_weighted <- df_Rem_covid_MCMC_weighted %>% ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line() +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"), alpha = 0.3, color=NA,
                show.legend = FALSE)
  

p_Rem_covid_MCMC_weighted + 
  ylab('Remembered Intensity of \nNegative Feelings') +
  ylim(1,5)+
  xlab('Experienced Intensity of \nNegative Feelings') +
  scale_color_manual(labels = c('Previous','Current (after 1 year)'), values = palette2var)+
  scale_fill_manual(values = palette2var)+
  labs(colour='') + 
  emomem_theme +
  theme(axis.title =element_text(size=24),
        legend.box.margin=margin(-10,-10,0,-10),
        legend.text = element_text(size = 18))

ggsave('../Output/fig/pdf/fig_recency_covid_new_ylab.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_covid_new_ylab.png',height=6,width=6)

# Fig 2C
nine11_BRem_T2 <- nine11_long_avg_T2 %>% mutate(B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  filter(!is.na(B911_Rem)) %>% filter(!is.na(prev_experience)) %>% filter(!is.na(curr_experience))
if (!exists("Rem_911_MCMC_T2_weighted")) {
Rem_911_MCMC_T2_weighted <- stan_glm(B911_Rem ~ prev_experience + curr_experience,
                                    family = mgcv::betar, iter= niters, seed=seed_no,
                                    weights = num_weights_updated, data = nine11_BRem_T2)
}

df_Rem_911_MCMC_T2_weighted <- Rem_911_MCMC_T2_weighted %>% plot_model_IVs_stan(variable_array = c('prev_experience','curr_experience'),
                                              x_range = seq(1,5,by=0.2), return_df = TRUE) %>% as.data.frame

df_Rem_911_MCMC_T2_weighted <- df_Rem_911_MCMC_T2_weighted %>% mutate(
across(!starts_with("x"), 
         function(x){return(reverse_beta_squeeze(x, n= length(nine11_BRem_T2$B911_Rem), likert_min_max = c(1,5)))},
         .names = "{.col}_original"))
 
p_Rem_911_MCMC_T2_weighted <- df_Rem_911_MCMC_T2_weighted %>% ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line() +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"), alpha = 0.3, color=NA,
                show.legend = FALSE)

p_Rem_911_MCMC_T2_weighted + 
  ylab('Remembered Intensity of \nNegative Feelings') +
  ylim(1,5)+
  xlab('Experienced Intensity of \nNegative Feelings') +
  scale_color_manual(labels = c('Previous','Current (after 1 year)'), values = palette2var)+
  scale_fill_manual(values = palette2var)+
  labs(colour='') +
  emomem_theme + 
  theme(axis.title =element_text(size=24),
        legend.box.margin=margin(-10,-10,0,-10),
        legend.text = element_text(size = 18))
ggsave('../Output/fig/pdf/fig_recency_911_T2_new_ylab.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_911_T2_new_ylab.png',height=6,width=6)

```

## Figure 2B, 2D
```{r mcmc interval}
# Fig 2B and 2D
p_coef_covid_weighted <- mcmc_intervals(as.array(Rem_covid_MCMC_weighted), pars = c('Covid_Exp1','Covid_Exp2'),
                                        prob_outer = 0.95)

p_coef_covid_weighted_area <- mcmc_areas(as.array(Rem_covid_MCMC_weighted), pars = c('Covid_Exp1','Covid_Exp2'),
                                        prob = 0.95)


p_coef_911_weighted_T2 <- mcmc_intervals(as.array(Rem_911_MCMC_T2_weighted), pars = c('prev_experience','curr_experience'), prob_outer = 0.95)

p_coef_911_weighted_T2_area <- mcmc_areas(as.array(Rem_911_MCMC_T2_weighted), pars = c('prev_experience','curr_experience'), prob = 0.95)

p_coef_covid_weighted_area + emomem_theme + 
  xlab('Coefficient Estimate') +
  scale_y_discrete(breaks = c('Covid_Exp1','Covid_Exp2'),
                   labels = c('Previous','Current\n(after 1 year)')) 
ggsave('../Output/fig/pdf/fig_recency_coef_covid_area.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_coef_covid_area.png',height=6,width=6)
  
p_coef_911_weighted_T2_area + emomem_theme +
  xlab('Coefficient Estimate') +
  scale_y_discrete(breaks = c('prev_experience','curr_experience'),
                   labels = c('Previous','Current\n(after 1 year)'))
ggsave('../Output/fig/pdf/fig_recency_coef_911_area.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_coef_911_area.png',height=6,width=6)

```
# Supplementary Figure 2
```{r}

covid_long_pca <- covid_wide %>% mutate(neg_PCA_T1 = -PCA_T1, neg_PCA_T2 = -PCA_T2) %>%
  filter(!is.na(neg_PCA_T1) & !is.na(neg_PCA_T2)) %>% pivot_longer(cols = c('neg_PCA_T1','neg_PCA_T2'),
                            names_to = 'time',
                            values_to = 'Subjective_Well_being') %>% 
  dplyr::select(Subject, time, Subjective_Well_being) %>% 
  mutate(time = factor(time, levels = c('neg_PCA_T1','neg_PCA_T2'),
                       labels = c('Previous','Current (after 1 year)')))

p_covid_long_pca <- covid_long_pca %>% ggplot(aes(x=time, y=Subjective_Well_being)) + 
  stat_summary() 
p_covid_long_pca + emomem_theme + 
  xlab('Time') + ylab('Subjective Well-being')

ggsave('../Output/fig/pdf/supp_pca.pdf',height=6,width=7)
ggsave('../Output/fig/png/supp_pca.png',height=6,width=7)

```

# Figure 4
```{r well-being}
covid_percent <- covid_wide %>% 
  mutate(BCovid_Dev = beta_squeeze((Covid_Dev+4)/8)) %>% 
  mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) %>% 
  filter(!is.na(BCovid_Dev)) %>% filter(!is.na(emo_well_being_delta))

if (!exists("covid_delta_EmoWell_MCMC")) {
covid_delta_EmoWell_MCMC <- stan_glm(BCovid_Dev ~ emo_well_being_delta + Covid_Exp1,
                                         family = mgcv::betar, seed = seed_no,
                                         iter= niters, weights = num_weights_3var,
                                         covid_percent %>% filter(!is.na(Covid_Exp1)))
}
df_delta_EmoWell <- covid_delta_EmoWell_MCMC %>% plot_model_IVs_stan(variable_array = c('emo_well_being_delta'), x_range = seq(-10,10,by = 0.5), return_df = TRUE) %>% as.data.frame

df_delta_EmoWell <- df_delta_EmoWell %>% mutate(
  across(!starts_with("x"),
         function(x){return(reverse_beta_squeeze(x, n=length(covid_percent %>% filter(!is.na(Covid_Exp1))),
                                                 likert_min_max = c(-4,4)))},
         .names = "{.col}_original"))

p_delta_EmoWell <- df_delta_EmoWell %>% 
ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line(color = 'black') +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"),fill='black', alpha = 0.3, color=NA,
                show.legend = FALSE)

p_delta_EmoWell + 
  geom_vline(xintercept = 0, linetype = 'dashed') + 
  xlab('Emotional Well-being\nImprovement in 1 Year') +
  ylab('Memory Deviation') + 
  emomem_theme + 
  theme(legend.position = 'none')

ggsave('../Output/fig/pdf/delta_wellbeing.pdf',height=6,width=6)
ggsave('../Output/fig/png/delta_wellbeing.png',height=6,width=6)

```

# Figure 3
```{r fig3}
# Fig 3
nine11_percent <- nine11_long_avg %>% 
  #mutate(Percent = memdev / twovar_prev_experience) %>% 
  mutate(Bdev = (memdev+4)/8) %>% 
  mutate(time = relevel(factor(time), ref='2')) %>% 
  #filter(!is.na(Percent))
  filter(!is.na(Bdev)) %>% 
  filter(!is.na(prev_experience))
p_911_avg <- nine11_percent %>% 
  mutate(time = factor(time, levels = c(2:4),
                       labels = c('1 year','3 years','10 years'))) %>% 
  ggplot(aes(x=time, y=memdev)) + 
    stat_summary() + 
    stat_summary(geom='line', aes(group=1))


p_911_avg + ylab('Memory Deviation') +
  xlab('Time Interval') +
  emomem_theme

ggsave('../Output/fig/pdf/avg_911_time.pdf',height=6,width=6)
ggsave('../Output/fig/png/avg_911_time.png',height=6,width=6)

```

# Supplementary Figure (covariate)

## Stress (NegEmo) ~ type (T1_experienced/T2_remembered/T2_experienced)
### Covid
#### Covariate - data viz

```{r}

fig1A_gender <- covid_long_type_plot %>% filter(T1_Demographics_gender == 'Male' | T1_Demographics_gender == 'Female') %>% 
  ggplot(aes(x = MemType, y = Stress, group = T1_Demographics_gender)) + 
  stat_summary(size=1.7) +
  facet_wrap(~T1_Demographics_gender)
fig1A_gender + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='')
ggsave('../Output/fig/pdf/fig1A_gender.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1A_gender.png',height=6,width=12)

fig1A_race <- covid_long_type_plot %>% filter(T1_Demographics_race_category != 'Other' & T1_Demographics_race_category != 'Mixed') %>% 
  ggplot(aes(x = MemType, y = Stress, group = T1_Demographics_race_category)) + 
  stat_summary(size=1.7) + facet_wrap(~T1_Demographics_race_category)
fig1A_race + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='') 
ggsave('../Output/fig/pdf/fig1A_race.pdf',height=6,width=18)
ggsave('../Output/fig/png/fig1A_race.png',height=6,width=18)

fig1A_eth <- covid_long_type_plot %>% 
  mutate(T1_Demographics_HispanicLatino = 
           factor(T1_Demographics_HispanicLatino, levels=c(0,1), labels=c('non-Hispanic','Hispanic'))) %>%
  filter(!is.na(T1_Demographics_HispanicLatino)) %>% 
  ggplot(aes(x = MemType, y = Stress, group = T1_Demographics_HispanicLatino)) + 
  stat_summary(size=1.7) + 
  facet_wrap(~T1_Demographics_HispanicLatino)
fig1A_eth + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='') # huge error bar for Hispanic!
ggsave('../Output/fig/pdf/fig1A_eth.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1A_eth.png',height=6,width=12)
```

#### Covariate - model viz 
```{r}
fig1A_gender_contrast <- MemType_covid_MCMC_covariate_gender %>% emmeans(specs = 'MemType', by = 'T1_Demographics_gender') %>% contrast('trt.vs.ctrl') 
plot(fig1A_gender_contrast) + facet_wrap(~T1_Demographics_gender, ncol = 2) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + 
  ylab('Contrast') + xlab('Estimate')

ggsave('../Output/fig/pdf/fig1A_gender_contrast.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1A_gender_contrast.png',height=6,width=12)

fig1A_race_contrast <- MemType_covid_MCMC_covariate_race %>% emmeans(specs = 'MemType', by = 'T1_Demographics_race_category') %>% contrast('trt.vs.ctrl') 
plot(fig1A_race_contrast[c(1:4 ,9:10)]) + facet_wrap(~T1_Demographics_race_category, scales='free_x', nrow = 1) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious')) + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme +  coord_flip() + 
  ylab('Contrast') + xlab('Estimate')

ggsave('../Output/fig/pdf/fig1A_race_contrast.pdf',height=6,width=18)
ggsave('../Output/fig/png/fig1A_race_contrast.png',height=6,width=18)

supp.labs <- c("Non-Hispanic", "Hispanic")
names(supp.labs) <- c("0", "1")

fig1A_eth_contrast <- MemType_covid_MCMC_covariate_eth %>% emmeans(specs = 'MemType', by = 'T1_Demographics_HispanicLatino') %>% contrast('trt.vs.ctrl') 
plot(fig1A_eth_contrast) + facet_wrap(~T1_Demographics_HispanicLatino, nrow = 1, labeller = labeller(T1_Demographics_HispanicLatino=supp.labs)) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme +  coord_flip() + 
  ylab('Contrast') + xlab('Estimate')
ggsave('../Output/fig/pdf/fig1A_eth_contrast.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1A_eth_contrast.png',height=6,width=12)


```

### 911
#### Covariate - data viz
```{r}
fig1B_gender <- nine11_long_type_plot %>% filter(gender == 'Male' | gender == 'Female') %>% 
  ggplot(aes(x = MemType, y = NegEmo, group = gender)) + 
  stat_summary(size=1.7) +
  facet_wrap(~gender)
fig1B_gender + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='')
ggsave('../Output/fig/pdf/fig1B_gender.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1B_gender.png',height=6,width=12)

fig1B_race <- nine11_long_type_plot %>% filter(race_category == 'Asian' | race_category == 'Black' | race_category == 'White') %>% 
  ggplot(aes(x = MemType, y = NegEmo, group = race_category)) + 
  stat_summary(size=1.7) +
  facet_wrap(~race_category, nrow=1)
fig1B_race + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='')
ggsave('../Output/fig/pdf/fig1B_race.pdf',height=6,width=18)
ggsave('../Output/fig/png/fig1B_race.png',height=6,width=18)

fig1B_eth <- nine11_long_type_plot %>% 
  mutate(eth_category = 
           factor(eth_category, levels=c('Other Or NA','Hispanic'), labels=c('non-Hispanic','Hispanic'))) %>% 
  ggplot(aes(x = MemType, y = NegEmo, group = eth_category)) + 
  stat_summary(size=1.7) +
  facet_wrap(~eth_category)
fig1B_eth + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_color_discrete(name='')
ggsave('../Output/fig/pdf/fig1B_eth.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1B_eth.png',height=6,width=12)

```

#### Covariate - model viz
```{r}
fig1B_gender_contrast <- MemType_911_MCMC_T2_gender %>% emmeans(specs = 'MemType', by = 'gender') %>% contrast('trt.vs.ctrl') 
plot(fig1B_gender_contrast[1:4]) + facet_wrap(~gender, scales='free_x',nrow = 1) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig1B_gender_contrast.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1B_gender_contrast.png',height=6,width=12)

fig1B_race_contrast <- MemType_911_MCMC_T2_race %>% emmeans(specs = 'MemType', by = 'race_category') %>% contrast('trt.vs.ctrl') 
plot(fig1B_race_contrast[c(1:4,7:8)]) + facet_wrap(~race_category, scales='free_x', nrow = 1) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious')) + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme  + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig1B_race_contrast.pdf',height=6,width=18)
ggsave('../Output/fig/png/fig1B_race_contrast.png',height=6,width=18)

supp.labs <- c("Hispanic", "Non-Hispanic")
names(supp.labs) <- c("Hispanic", "Other Or NA")

fig1B_eth_contrast <- MemType_911_MCMC_T2_eth %>% emmeans(specs = 'MemType', by = 'eth_category') %>% contrast('trt.vs.ctrl') 
plot(fig1B_eth_contrast) + facet_wrap(~eth_category, nrow = 1, labeller = labeller(eth_category=supp.labs)) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig1B_eth_contrast.pdf',height=6,width=12)
ggsave('../Output/fig/png/fig1B_eth_contrast.png',height=6,width=12)



```
#### Separate emotion - data viz

\textcolor{red}{**note:**} The code for this graph has been udpated

```{r}
nine11_wide_type_new <- nine11_wide %>% dplyr::select(Subject, item, experienced1, experienced2, remembered2, memdev2) %>% rename(Previous=experienced1, Current=experienced2, Remembered=remembered2) %>% 
  # mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
  #        B911_Exp2 = beta_squeeze((curr_experience-1)/4),
  #        B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('Previous', 'Current','Remembered'),
               names_to = 'MemType', values_to = 'NegEmo') %>% 
  filter(!is.na(NegEmo))
nine11_wide_type_new_avg <- nine11_wide_type_new %>% 
  dplyr::select(Subject, item, MemType, NegEmo) %>% 
  mutate(MemType = as.character(MemType)) %>% 
  rbind(
    nine11_long_type_plot %>% 
      mutate(item = 'average') %>% 
      dplyr::select(Subject, item, MemType, NegEmo) %>% 
      mutate(MemType = as.character(MemType) %>% str_trim())
  ) %>% 
  mutate(MemType = factor(MemType, levels=c('Previous','Current','Remembered')),
         item = factor(item, levels=c('frustration','anger','confusion','fear','sadness','shock','average')))

fig1B_discrete_new <- nine11_wide_type_new_avg %>% 
  ggplot(aes(x = MemType, y = NegEmo)) + 
  stat_summary(size=1, aes(group=item, color=item)) +
  stat_summary(size=1, aes(group=item, color=item), geom='line') 
fig1B_discrete_new + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_x_discrete(labels=c('Previous','Current','Remembered'))+
  scale_color_discrete(name='')+
  theme(legend.position = 'right')

ggsave('../Output/fig/pdf/fig1B_discrete_avg.pdf',height=6,width=9)
ggsave('../Output/fig/png/fig1B_discrete_avg.png',height=6,width=9)

fig1B_discrete <- nine11_wide_type %>% 
  ggplot(aes(x = MemType, y = stress_memory)) + 
  stat_summary(size=1, aes(group=item, color=item)) 
fig1B_discrete + emomem_theme + 
  ylab('Intensity of Negative Feelings') +
  xlab('') +
  scale_x_discrete(labels=c('Previous','Current','Remembered'))+
  scale_color_discrete(name='')+
  theme(legend.position = 'right')
ggsave('../Output/fig/pdf/fig1B_discrete.pdf',height=6,width=9)
ggsave('../Output/fig/png/fig1B_discrete.png',height=6,width=9)

```

```{r}
# basically now trying to do this analysis given the reviewer's argument: are the within-subject differences between a remembered and experienced emotion (for a specific emotion, e.g., remembered anger versus previous anger) smaller than the within-subject differences between different remembered emotions?

a <- nine11_wide %>% dplyr::select(Subject, item, experienced1, experienced2, remembered2, memdev2) %>% rename(prev_experience=experienced1, curr_experience=experienced2, stress_memory=remembered2, dev=memdev2) %>%
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))

```


#### Separate emotion - model viz
```{r}

fig1B_discrete_contrast <- MemType_911_MCMC_T2_discrete %>% emmeans(specs = 'MemType', by = 'item') %>% contrast('trt.vs.ctrl') 
plot(fig1B_discrete_contrast) + facet_wrap(~item, scales='free_x',nrow = 2) + scale_y_discrete(labels=c('Current -\nPrevious','Remembered -\nPrevious'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + xlab('Estimate') + ylab('Contrast') + coord_flip()
ggsave('../Output/fig/pdf/fig1B_discrete_contrast.pdf',height=12,width= 18)
ggsave('../Output/fig/png/fig1B_discrete_contrast.png',height=12, width=18)

```

## Rem ~ Exp1 + Exp2
### Covid
#### Covariate - data viz
```{r}
fig2a_gender <- ggplot(data = covid_wide %>% filter(T1_Demographics_gender != 'Other'), aes(y=Covid_Rem)) + 
  geom_smooth(aes(x = Covid_Exp1), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = Covid_Exp2), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~T1_Demographics_gender)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme 
ggsave('../Output/fig/pdf/fig2a_gender.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2a_gender.png',height=6, width=12)

fig2a_race <- ggplot(data = covid_wide %>% filter(T1_Demographics_race_category != 'Mixed' & T1_Demographics_race_category != 'Other' ), aes(y=Covid_Rem)) + 
  geom_smooth(aes(x = Covid_Exp1), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = Covid_Exp2), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~T1_Demographics_race_category)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2a_race.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fig2a_race.png',height=6, width=18)


fig2a_eth <- ggplot(data = covid_wide %>% filter(!is.na(T1_Demographics_HispanicLatino)) %>% 
         mutate(T1_Demographics_HispanicLatino = ifelse(T1_Demographics_HispanicLatino==0, 'non-Hispanic','Hispanic')) , aes(y=Covid_Rem)) + 
  geom_smooth(aes(x = Covid_Exp1), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = Covid_Exp2), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~T1_Demographics_HispanicLatino)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2a_eth.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2a_eth.png',height=6, width=12)

```

#### Covariate - model viz
```{r}
fig2b_gender_contrast <- Rem_covid_MCMC_weighted_gender %>% emtrends(specs = 'T1_Demographics_gender', var = 'Covid_Exp2') %>% as.data.frame %>% mutate(type='Covid_Exp2') %>% rename(trend=Covid_Exp2.trend) %>% 
  rbind(Rem_covid_MCMC_weighted_gender %>% emtrends(specs = 'T1_Demographics_gender', var = 'Covid_Exp1') %>% as.data.frame %>% mutate(type='Covid_Exp1') %>% rename(trend=Covid_Exp1.trend))

fig2b_gender_contrast %>% filter(T1_Demographics_gender != 'Other') %>% ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~T1_Demographics_gender) + emomem_theme + coord_flip()
ggsave('../Output/fig/pdf/fig2a_gender_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2a_gender_contrast.png',height=6, width=12)

fig2b_race_contrast <- Rem_covid_MCMC_weighted_race %>% emtrends(specs = 'T1_Demographics_race_category', var = 'Covid_Exp2') %>% as.data.frame %>% mutate(type='Covid_Exp2') %>% rename(trend=Covid_Exp2.trend) %>% 
  rbind(Rem_covid_MCMC_weighted_race %>% emtrends(specs = 'T1_Demographics_race_category', var = 'Covid_Exp1') %>% as.data.frame %>% mutate(type='Covid_Exp1') %>% rename(trend=Covid_Exp1.trend))

fig2b_race_contrast %>% filter(T1_Demographics_race_category != 'Other' & T1_Demographics_race_category != 'Mixed') %>% ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~T1_Demographics_race_category) + emomem_theme + coord_flip()
ggsave('../Output/fig/pdf/fig2a_race_contrast.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fig2a_race_contrast.png',height=6, width=18)

fig2b_eth_contrast <- Rem_covid_MCMC_weighted_eth %>% emtrends(specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp2') %>% as.data.frame %>% mutate(type='Covid_Exp2') %>% rename(trend=Covid_Exp2.trend) %>% 
  rbind(Rem_covid_MCMC_weighted_eth %>% emtrends(specs = 'T1_Demographics_HispanicLatino', var = 'Covid_Exp1') %>% as.data.frame %>% mutate(type='Covid_Exp1') %>% rename(trend=Covid_Exp1.trend))

fig2b_eth_contrast %>% mutate(T1_Demographics_HispanicLatino = ifelse(T1_Demographics_HispanicLatino==0, 'non-Hispanic','Hispanic')) %>% ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~T1_Demographics_HispanicLatino) + emomem_theme + coord_flip()
ggsave('../Output/fig/pdf/fig2a_eth_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2a_eth_contrast.png',height=6, width=12)
 
```


### 9/11
#### Covariate - data viz
```{r}
fig2c_gender <- ggplot(data = nine11_BRem_T2 %>% filter(gender != 'Not stated'), aes(y=stress_memory)) + 
  geom_smooth(aes(x = prev_experience), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = curr_experience), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~gender)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2c_gender.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2c_gender.png',height=6, width=12)


fig2c_race <- ggplot(data = nine11_BRem_T2 %>% filter(race_category != 'Other Or NA'), aes(y=stress_memory)) + 
  geom_smooth(aes(x = prev_experience), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = curr_experience), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~race_category)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2c_race.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fig2c_race.png',height=6, width=18)

fig2c_eth <- ggplot(data = nine11_BRem_T2 %>% mutate(eth_category = ifelse(eth_category=='Other Or NA','Non-Hispanic','Hispanic')), aes(y=stress_memory)) + 
  geom_smooth(aes(x = prev_experience), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = curr_experience), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~eth_category)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2c_eth.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2c_eth.png',height=6, width=12)

```

#### Covariate - model viz
```{r}
fig2d_gender_contrast <- Rem_911_MCMC_T2_weighted_gender %>% emtrends(specs = 'gender', var = 'curr_experience') %>% as.data.frame %>% mutate(type='curr_experience') %>% rename(trend=curr_experience.trend) %>% 
  rbind(Rem_911_MCMC_T2_weighted_gender %>% emtrends(specs = 'gender', var = 'prev_experience') %>% as.data.frame %>% mutate(type='prev_experience') %>% rename(trend=prev_experience.trend))

fig2d_gender_contrast %>% filter(gender != 'Not stated') %>% ggplot(aes(y=type, x=trend)) + 
  #geom_ribbonh(aes(xmin=lower.HPD, xmax=upper.HPD), color='blue') + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~gender) + emomem_theme + coord_flip() 
ggsave('../Output/fig/pdf/fig2c_gender_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2c_gender_contrast.png',height=6, width=12)

fig2d_race_contrast <- Rem_911_MCMC_T2_weighted_race %>% emtrends(specs = 'race_category', var = 'curr_experience') %>% as.data.frame %>% mutate(type='curr_experience') %>% rename(trend=curr_experience.trend) %>% 
  rbind(Rem_911_MCMC_T2_weighted_race %>% emtrends(specs = 'race_category', var = 'prev_experience') %>% as.data.frame %>% mutate(type='prev_experience') %>% rename(trend=prev_experience.trend))

fig2d_race_contrast %>% filter(race_category != 'Other Or NA') %>% ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~race_category) +emomem_theme+coord_flip()
ggsave('../Output/fig/pdf/fig2c_race_contrast.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fig2c_race_contrast.png',height=6, width=18)


fig2d_eth_contrast <- Rem_911_MCMC_T2_weighted_eth %>% emtrends(specs = 'eth_category', var = 'curr_experience') %>% as.data.frame %>% mutate(type='curr_experience') %>% rename(trend=curr_experience.trend) %>% 
  rbind(Rem_911_MCMC_T2_weighted_eth %>% emtrends(specs = 'eth_category', var = 'prev_experience') %>% as.data.frame %>% mutate(type='prev_experience') %>% rename(trend=prev_experience.trend))

fig2d_eth_contrast %>%  
  mutate(eth_category=ifelse(eth_category=='Other Or NA','Non-Hispanic','Hispanic')) %>% 
  ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~eth_category) +emomem_theme+coord_flip()
ggsave('../Output/fig/pdf/fig2c_eth_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2c_eth_contrast.png',height=6, width=12)

```

#### Separate emotion - data viz
```{r}
nine11_BRem_T2_discrete %>% ggplot(aes(y=stress_memory)) + 
  geom_smooth(aes(x = prev_experience), formula = 'y~x', method='lm', color='black', alpha=0.3) +
  geom_smooth(aes(x = curr_experience), formula = 'y~x', method='lm', color='darkgrey', alpha=0.3) +  facet_wrap(~item)+
  xlab('Experienced Intensity of Negative Feelings')+
  ylab('Remembered Intensity of\nNegative Feelings')+
  emomem_theme
ggsave('../Output/fig/pdf/fig2c_discrete.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig2c_discrete.png',height=6, width=12)

```

#### Separate Emotion - model viz
```{r}
fig2d_discrete_contrast <- Rem_911_MCMC_discrete %>% emtrends(specs = 'item', var = 'curr_experience') %>% as.data.frame %>% mutate(type='curr_experience') %>% rename(trend=curr_experience.trend) %>% 
  rbind(Rem_911_MCMC_discrete %>% emtrends(specs = 'item', var = 'prev_experience') %>% as.data.frame %>% mutate(type='prev_experience') %>% rename(trend=prev_experience.trend))

fig2d_discrete_contrast %>% ggplot(aes(y=type, x=trend)) + 
  geom_point() +
  geom_errorbarh(aes(xmin=lower.HPD, xmax=upper.HPD), linewidth=3, color='blue', alpha=0.2, height=0) + 
  xlab('Coefficient Estimate')+
  scale_y_discrete(name='',labels=c('Previous','Current\n(after 1 year)'))+
  facet_wrap(~item) + emomem_theme + coord_flip()
ggsave('../Output/fig/pdf/fig2c_discrete_contrast.pdf',height=12,width= 18)
ggsave('../Output/fig/png/fig2c_discrete_contrast.png',height=12, width=18)

```

## Dev ~ MemTime + prev_experience 
### 9/11
#### Covariate - data viz
```{r}
p_911_avg_gender <- nine11_percent %>% 
  filter(gender != 'Not stated') %>% 
  mutate(time = factor(time, levels = c(2:4),
                       labels = c('1 year','3 years','10 years'))) %>% 
  ggplot(aes(x=time, y=memdev, group=gender)) + 
    stat_summary() + 
    stat_summary(geom='line', aes(group=1))

p_911_avg_gender + ylab('Memory Deviation') +
  xlab('Time Interval') +
  facet_wrap(~gender)+
  emomem_theme
ggsave('../Output/fig/pdf/fig3_gender.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fige_gender.png',height=6, width=12)

p_911_avg_race <- nine11_percent %>% 
  filter(race_category != 'Other Or NA' & race_category != 'Mixed') %>% 
  mutate(time = factor(time, levels = c(2:4),
                       labels = c('1 year','3 years','10 years'))) %>% 
  ggplot(aes(x=time, y=memdev, group=race_category)) + 
    stat_summary() + 
    stat_summary(geom='line', aes(group=1))

p_911_avg_race + ylab('Memory Deviation') +
  xlab('Time Interval') +
  facet_wrap(~race_category)+
  emomem_theme
ggsave('../Output/fig/pdf/fig3_race.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fige_race.png',height=6, width=18)

p_911_avg_eth <- nine11_percent %>% 
  mutate(eth_category=ifelse(eth_category=='Other Or NA','Non-Hispanic',eth_category)) %>% 
  mutate(time = factor(time, levels = c(2:4),
                       labels = c('1 year','3 years','10 years'))) %>% 
  ggplot(aes(x=time, y=memdev, group=eth_category)) + 
    stat_summary() + 
    stat_summary(geom='line', aes(group=1))

p_911_avg_eth + ylab('Memory Deviation') +
  xlab('Time Interval') +
  facet_wrap(~eth_category)+
  emomem_theme
ggsave('../Output/fig/pdf/fig3_eth.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fige_eth.png',height=6, width=12)
```

#### Covariate - model viz
```{r}
fig3_gender_contrast <- Time_avg_911_MCMC_weighted_gender %>% emmeans(specs = 'time', by = 'gender') %>% contrast('trt.vs.ctrl') 
plot(fig3_gender_contrast[1:4]) + facet_wrap(~gender, nrow = 1, scale='free_x') + scale_y_discrete(labels=c('3 years -\n1 year','10 years -\n1 year'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig3_gender_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fige_gender_contrast.png',height=6, width=12)

fig3_race_contrast <- Time_avg_911_MCMC_weighted_race %>% emmeans(specs = 'time', by = 'race_category') %>% contrast('trt.vs.ctrl') 
plot(fig3_race_contrast[c(1:4,7:8)]) + facet_wrap(~race_category, nrow = 1, scale='free_x') + scale_y_discrete(labels=c('3 years -\n1 year','10 years -\n1 year'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig3_race_contrast.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fige_race_contrast.png',height=6, width=18)

supp.labs <- c("Hispanic", "Non-Hispanic")
names(supp.labs) <- c("Hispanic", "Other Or NA")

fig3_eth_contrast <- Time_avg_911_MCMC_weighted_eth %>% emmeans(specs = 'time', by = 'eth_category') %>% contrast('trt.vs.ctrl') 
plot(fig3_eth_contrast) + facet_wrap(~eth_category, nrow = 1, scale='free_x', labeller=labeller(eth_category=supp.labs)) + scale_y_discrete(labels=c('3 years -\n1 year','10 years -\n1 year'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig3_eth_contrast.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fige_eth_contrast.png',height=6, width=12)
```

#### Separate emotion - data viz
```{r}
p_911_discrete <- nine11_wide_subj_dev %>% 
  mutate(time = factor(MemTime, levels = c('memdev2', 'memdev3', 'memdev4'),
                       labels = c('1 year','3 years','10 years'))) %>% 
  ggplot(aes(x=time, y=Dev)) + 
    stat_summary(aes(group=item, color=item)) + 
    stat_summary(geom='line', aes(group=item, color=item))

p_911_discrete + ylab('Memory Deviation') +
  xlab('Time Interval') +
  emomem_theme + 
  scale_color_discrete(name='')+
  theme(legend.position = 'right')
ggsave('../Output/fig/pdf/fig3_discrete.pdf',height=6,width= 9)
ggsave('../Output/fig/png/fige_discrete.png',height=6, width=9)
```

#### Separate emotion - model viz
```{r}
fig3_discrete_contrast <- StressOTEmo911_MCMC_withprev %>% emmeans(specs = 'MemTime', by = 'item') %>% contrast('trt.vs.ctrl') 
plot(fig3_discrete_contrast) + facet_wrap(~item, nrow = 2, scale='free_x') + scale_y_discrete(labels=c('3 years -\n1 year','10 years -\n1 year'))  + geom_vline(xintercept = 0, color='red', linetype='dashed') + 
  emomem_theme + coord_flip() + xlab('Estimate') + ylab('Contrast')
ggsave('../Output/fig/pdf/fig3_discrete_contrast.pdf',height=12,width= 18)
ggsave('../Output/fig/png/fige_discrete_contrast.png',height=12, width=18)
```

## Separate Analysis Overestimation ~ Delta Emotion Well-being
### Covid - delta emo
#### Covariate - data viz
```{r}
covid_long_pca_demo <- covid_wide %>% mutate(neg_PCA_T1 = -PCA_T1, neg_PCA_T2 = -PCA_T2) %>%
  filter(!is.na(neg_PCA_T1) & !is.na(neg_PCA_T2)) %>% pivot_longer(cols = c('neg_PCA_T1','neg_PCA_T2'),
                            names_to = 'time',
                            values_to = 'Subjective_Well_being') %>% 
  dplyr::select(Subject, time, Subjective_Well_being, T1_Demographics_gender, T1_Demographics_race_category, T1_Demographics_HispanicLatino) %>% 
  mutate(time = factor(time, levels = c('neg_PCA_T1','neg_PCA_T2'),
                       labels = c('Previous','Current (after 1 year)')))
p_covid_long_pca_gender <- covid_long_pca_demo %>%
  filter(T1_Demographics_gender != 'Other') %>% ggplot(aes(x=time, y=Subjective_Well_being)) + 
  stat_summary() + facet_wrap(~T1_Demographics_gender)
p_covid_long_pca_gender + emomem_theme + 
  xlab('Time') + ylab('Subjective Well-being')
ggsave('../Output/fig/pdf/fig4_gender.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig4_gender.png',height=6, width=12)

p_covid_long_pca_race <- covid_long_pca_demo %>%
  filter(T1_Demographics_race_category != 'Other' & T1_Demographics_race_category != 'Mixed') %>% ggplot(aes(x=time, y=Subjective_Well_being)) + 
  stat_summary() + facet_wrap(~T1_Demographics_race_category)
p_covid_long_pca_race + emomem_theme + 
  xlab('Time') + ylab('Subjective Well-being')
ggsave('../Output/fig/pdf/fig4_race.pdf',height=6,width= 18)
ggsave('../Output/fig/png/fig4_race.png',height=6, width=18)

p_covid_long_pca_eth <- covid_long_pca_demo %>%
  mutate(T1_Demographics_HispanicLatino=ifelse(T1_Demographics_HispanicLatino==0, 'non-Hispanic','Hispanic')) %>% 
   ggplot(aes(x=time, y=Subjective_Well_being)) + 
  stat_summary() + facet_wrap(~T1_Demographics_HispanicLatino)
p_covid_long_pca_eth + emomem_theme + 
  xlab('Time') + ylab('Subjective Well-being')
ggsave('../Output/fig/pdf/fig4_eth.pdf',height=6,width= 12)
ggsave('../Output/fig/png/fig4_eth.png',height=6, width=12)


```

### Covid - relationship
#### Covariate - data viz
```{r}
p_delta_EmoWell_gender <- covid_percent %>%
  filter(T1_Demographics_gender != 'Other') %>% ggplot(aes(x=PCA_delta, y=Covid_Dev)) + 
  geom_smooth(formula='y~x',method='lm', aes(group=T1_Demographics_gender, fill=T1_Demographics_gender, color=T1_Demographics_gender), alpha=0.2)

p_delta_EmoWell_gender + 
  geom_vline(xintercept = 0, linetype = 'dashed') + 
  xlab('Emotional Well-being\nImprovement in 1 Year') +
  ylab('Memory Deviation') + 
  emomem_theme + 
  scale_color_discrete(name='')+
  scale_fill_discrete(name='')
ggsave('../Output/fig/pdf/fig4_gender_contrast.pdf',height=6,width= 6)
ggsave('../Output/fig/png/fig4_gender_contrast.png',height=6, width=6)

p_delta_EmoWell_race <- covid_percent %>%
  filter(T1_Demographics_race_category != 'Other' & T1_Demographics_race_category != 'Mixed') %>% ggplot(aes(x=PCA_delta, y=Covid_Dev)) + 
  geom_smooth(formula='y~x',method='lm', aes(group=T1_Demographics_race_category, fill=T1_Demographics_race_category, color=T1_Demographics_race_category), alpha=0.2)

p_delta_EmoWell_race + 
  geom_vline(xintercept = 0, linetype = 'dashed') + 
  xlab('Emotional Well-being\nImprovement in 1 Year') +
  ylab('Memory Deviation') + 
  emomem_theme + 
  scale_color_discrete(name='')+
  scale_fill_discrete(name='')
ggsave('../Output/fig/pdf/fig4_race_contrast.pdf',height=6,width= 6)
ggsave('../Output/fig/png/fig4_race_contrast.png',height=6, width=6)

p_delta_EmoWell_eth <- covid_percent %>%
  mutate(T1_Demographics_HispanicLatino = ifelse(T1_Demographics_HispanicLatino==0, 'Non-Hispanic', 'Hispanic')) %>% 
  ggplot(aes(x=PCA_delta, y=Covid_Dev)) + 
  geom_smooth(formula='y~x',method='lm', aes(group=T1_Demographics_HispanicLatino, fill=T1_Demographics_HispanicLatino, color=T1_Demographics_HispanicLatino), alpha=0.2)

p_delta_EmoWell_eth + 
  geom_vline(xintercept = 0, linetype = 'dashed') + 
  xlab('Emotional Well-being\nImprovement in 1 Year') +
  ylab('Memory Deviation') + 
  emomem_theme + 
  scale_color_discrete(name='')+
  scale_fill_discrete(name='')
ggsave('../Output/fig/pdf/fig4_eth_contrast.pdf',height=6,width= 6)
ggsave('../Output/fig/png/fig4_eth_contrast.png',height=6, width=6)

```

```{r}
sessionInfo()
```

