---
title: "Plot and Descriptive Stats for Covid Project"
output: 
  rmarkdown::github_document:
    toc: true
    #toc_float: true
    toc_depth: 4
---

This is an R Markdown file for the plots in the covid project manuscript as well as the descriptive stats part.

Make sure you have the MCMC output (huge .RData file) included in the current directory before you run this .Rmd file.

```{r load dependency and datafile, include=FALSE}
source('utils.R')
# read in data
load(file = "~/OneDrive - Harvard University/911nCovid_StressMemory_new.rda") # this is not included in github repo
covid_wide <-  read.csv('../data/Complete_test_Dev_Exp_Only_Data_Manipulation.csv') #each row is one observation, T1 and T2 separated by prefix in the colnmae
nine11_wide_avg <- read.csv('../data/df.emo.wide.avg_Only_Data_Manipulation.csv') #each row is one observation at one time point, stress_memory is avg across emotions
nine11_wide <- read.csv('../data/df.emo.wide_Only_Data_Manipulation.csv') #each row is one observation at one time point, stress_memory is specific to one emotion
nine11_long_avg <- read.csv('../data/df.emo.long.avg_Only_Data_Manipulation.csv') #each row is one observation at one time point, stress_memory is avg across emotions

#  filter time2 data frome 911 to do shared analysis 
nine11_long_avg_T2 <- nine11_long_avg %>% filter(time==2)
nine11_wide_T2 <- nine11_wide %>% dplyr::select(!ends_with('3') & !ends_with('4'))

## define var related to MCMC
niters <- 20000
seed_no <- 1636
```

# Descriptive Stats for the dataset

```{r delta time}
# delta time
covid_wide$Dat_Delta <- as.Date(covid_wide$T2_StartDate) - as.Date(covid_wide$T2_Dat)
mean(covid_wide$Dat_Delta)
sqrt(var(covid_wide$Dat_Delta))

covid_wide$T1_Demographics_gender %>% table(useNA = 'ifany')

covid_wide %>% ggplot(aes(x=as.double(Dat_Delta))) +
   geom_histogram(color='black') +
   xlab('T2-T1 (days)') +
  emomem_theme

ggsave('../Output/fig/pdf/Supp_delta_date.pdf', height=6, width=8)
ggsave('../Output/fig/png/Supp_delta_date.png', height=6, width=8)
```

# Supplementary Table for Covid related stressors
```{r}
T1_covid_header <- read.csv('../data-raw/COVIDdata_vertical_new_q.csv')
T1_covid_item <- T1_covid_header %>% filter(str_detect(Header, 'lifechanges'))
T1_covid_item %>% mutate(Item = str_replace(Item, 'How much stress are you experiencing right now as a result of...', '')) %>% select(Item) %>% rename(`How much stress are you experiencing right now as a result of...`=Item) %>% 
  as.data.frame %>% write.csv('../Output/csv/Supp_T1_covid_item.csv')
```

# Percentage of overestimation

```{r}
covid_percent <- covid_wide %>% mutate(Percent = Covid_Dev / twovar_Covid_Exp1) %>% filter(!is.na(Percent)) 
nine11_percent_T2 <- nine11_long_avg_T2 %>% mutate(Percent = memdev / twovar_prev_experience) %>% filter(!is.na(Percent))
combined_percent <- covid_percent %>% dplyr::select(Subject, Percent, Covid_Dev, twovar_Covid_Exp1, num_weights_2var) %>% 
  rename(dev = Covid_Dev, twovar_prev = twovar_Covid_Exp1, num_weights = num_weights_2var) %>% 
  mutate(Dataset = 'Covid') %>% 
  rbind(
    nine11_percent_T2 %>% dplyr::select(Subject, Percent, memdev, twovar_prev_experience, num_weights_updated) %>% 
      rename(dev = memdev, twovar_prev = twovar_prev_experience, num_weights = num_weights_updated) %>% 
      mutate(Dataset = '911')
  ) %>% 
  mutate(Dataset = relevel(factor(Dataset), ref = 'Covid')) %>% 
  group_by(Dataset) %>% 
  mutate(Bdev = beta_squeeze((dev+4)/8))

combined_percent %>% group_by(Dataset) %>% summarise(mean=mean(Percent), sd=sqrt(var(Percent)))

```


# Loading Matrix for PCA
```{r PCA Loading Matrix}

df.prev_pca <- covid_wide %>% select(T2_prolific_mturk_ID, starts_with('T1_PSS') & !contains('total'), starts_with('T1_DASS') & !contains('total')) %>% na.omit 
prev_pca <- df.prev_pca %>% select(-T2_prolific_mturk_ID) %>% 
  prcomp(center=TRUE, scale. =TRUE)

df.curr_pca <- covid_wide %>% select(T2_prolific_mturk_ID, 
                                   starts_with('T2_PSS') & !contains('total'), 
                                   starts_with('T2_DASS') & !contains('total')) %>% 
  na.omit %>% 
  mutate(T2_PSS_4=4-T2_PSS_4, T2_PSS_5=4-T2_PSS_5, T2_PSS_7=4-T2_PSS_7, T2_PSS_8=4-T2_PSS_8) %>% 
  set_colnames(colnames(df.prev_pca))

df.prev_pca$prev_pca_score <- (prev_pca$x[,1]) * (-1)
df.curr_pca$curr_pca_score <- ((prev_pca %>% predict(df.curr_pca %>% select(-T2_prolific_mturk_ID)))[,1]) * (-1)

# loading matrix
loading.prev_pca <- data.frame(Loading = prev_pca$rotation[,1]) %>% rownames_to_column(var='T1_Scale_Item') %>% 
  mutate(Scale = str_extract(T1_Scale_Item, 'PSS|DASS'), Index = str_extract(T1_Scale_Item, '(?<=_)[0-9]+'))
loading_header.prev_pca <- T1_covid_header %>% filter(str_detect(Header,'PSS_') | str_detect(Header, 'DASS21_')) %>% 
  mutate(Scale = str_extract(Header, 'PSS|DASS'), Index = str_extract(Header, '(?<=_)[0-9]+')) 
loading.prev_pca %>% merge(loading_header.prev_pca, by = c('Scale','Index')) %>% select(Scale, Item, Loading) %>% 
  mutate(Loading = round(Loading, 3)) %>% 
  write.csv('../Output/csv/Supp_PCA_loading.csv')

```

```{r correlate with subscale}
covid_wide <- covid_wide %>% 
  mutate(T1_PSS_total = rowSums(covid_wide %>% select(T1_PSS_1:T1_PSS_10)),
         T2_PSS_total = T2_PSS_1 + T2_PSS_2 + T2_PSS_3 + 4 - T2_PSS_4 + 4 - T2_PSS_5 + T2_PSS_6 + 4 - T2_PSS_7 + 4 - T2_PSS_8 + T2_PSS_9 + T2_PSS_10,
         T1_DASS_total_S = T1_DASS_1 + T1_DASS_6 + T1_DASS_8 + T1_DASS_11 + T1_DASS_12 + T1_DASS_14 + T1_DASS_18,
         T1_DASS_total_A = T1_DASS_2 + T1_DASS_4 + T1_DASS_7 + T1_DASS_9 + T1_DASS_15 + T1_DASS_19 + T1_DASS_20,
         T1_DASS_total_D = T1_DASS21_3_Depression + T1_DASS_5 + T1_DASS_13 +T1_DASS_16 + T1_DASS_17 + T1_DASS_21,
         T2_DASS_total_S = T2_DASS_1 + T2_DASS_6 + T2_DASS_8 + T2_DASS_11 + T2_DASS_12 + T2_DASS_14 + T2_DASS_18,
T2_DASS_total_A = T2_DASS_2 + T2_DASS_4 + T2_DASS_7 + T2_DASS_9 + T2_DASS_15 + T2_DASS_19 + T2_DASS_20,
T2_DASS_total_D = T2_DASS_3 + T2_DASS_5 + T2_DASS_13 +T2_DASS_16 + T2_DASS_17 + T2_DASS_21,
neg_PCA_T1 = -PCA_T1,
neg_PCA_T2 = -PCA_T2
           )

r_pca <- covid_wide %>% select(neg_PCA_T1, neg_PCA_T2, T1_PSS_total, T1_DASS_total_A, T1_DASS_total_D, T1_DASS_total_S, 
                      T2_PSS_total, T2_DASS_total_A, T2_DASS_total_D, T2_DASS_total_S) %>% as.matrix() %>% 
  rcorr()
r_pca_rowname <- c('T1 Subjective Well-being', 'T2 Subjective Well-being', 'T1 PSS', 'T1 DASS Anxiety', 'T1 DASS Depression', 'T1 DASS Stress','T2 PSS', 'T2 DASS Anxiety', 'T2 DASS Depression', 'T2 DASS Stress' )
r_pca$r[,1:2] %>% round(3) %>% 
  set_rownames(r_pca_rowname) %>% 
  set_colnames(r_pca_rowname[1:2]) %>% 
  write.csv('../Output/csv/r_pca.csv')
```


# Figure 1
```{r Figure 1}

# Fig 1A
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))

covid_long_type_plot <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('Covid_Exp1','Covid_Exp2','Covid_Rem'),
               names_to = 'MemType', values_to = 'Stress') %>% 
  mutate(MemType = factor(MemType, levels = c('Covid_Exp1','Covid_Exp2','Covid_Rem'),
                          labels = c('Previous ', 'Current ', 'Remembered'))) %>% 
  filter(!is.na(Stress)) 
  

fig1A <- covid_long_type_plot %>% ggplot(aes(x = MemType, y = Stress)) + 
  stat_summary() 

fig1A + emomem_theme + 
  ylab('Average Stress') +
  xlab('') 
ggsave('../Output/fig/pdf/fig_stress_compare.pdf',height=6,width=7)
ggsave('../Output/fig/png/fig_stress_compare.png',height=6,width=7)
  
 # Fig 1B
nine11_long_type <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))

nine11_long_type_plot <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('prev_experience', 'curr_experience','stress_memory'),
               names_to = 'MemType', values_to = 'NegEmo') %>% 
  mutate(MemType = factor(MemType, levels = c('prev_experience','curr_experience','stress_memory'),
                          labels = c('Previous ', 'Current ', 'Remembered'))) %>% 
  filter(!is.na(NegEmo))

fig1B <- nine11_long_type_plot %>% ggplot(aes(x = MemType, y = NegEmo)) + 
  stat_summary()
fig1B + emomem_theme + 
  ylab('Average Negative Emotion Intensity') +
  xlab('') 
ggsave('../Output/fig/pdf/fig_negemo_compare.pdf',height=6,width=7)
ggsave('../Output/fig/png/fig_negemo_compare.png',height=6,width=7)
  

# Fig 1C
# not quite sure how to deal with this...
```



```{r Fig 2}
# Fig 2A

# because we want y to be on its original scale, we need to extract the data and can not use plot_model_IVs_stan wrapper
df_Rem_covid_MCMC_weighted <- Rem_covid_MCMC_weighted %>% plot_model_IVs_stan(variable_array = c('Covid_Exp1','Covid_Exp2'),
                                              x_range = seq(1,5,by=0.2), return_df = TRUE) %>% as.data.frame
df_Rem_covid_MCMC_weighted <- df_Rem_covid_MCMC_weighted %>% mutate(
  across(!starts_with("x"), 
         function(x){return(reverse_beta_squeeze(x, n= length(covid_BRem$BCovid_Rem), likert_min_max = c(1,5)))},
         .names = "{.col}_original"))
 

p_Rem_covid_MCMC_weighted <- df_Rem_covid_MCMC_weighted %>% ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line() +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"), alpha = 0.3, color=NA,
                show.legend = FALSE)
  

p_Rem_covid_MCMC_weighted + 
  ylab('Remembered Stress') +
  ylim(1,5)+
  xlab('Experienced Stress') +
  scale_color_manual(labels = c('Previous','Current (after 1 year)'), values = palette2var)+
  scale_fill_manual(values = palette2var)+
  labs(colour='') + 
  emomem_theme

ggsave('../Output/fig/pdf/fig_recency_covid.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_covid.png',height=6,width=6)

# Fig 2C
df_Rem_911_MCMC_T2_weighted <- Rem_911_MCMC_T2_weighted %>% plot_model_IVs_stan(variable_array = c('prev_experience','curr_experience'),
                                              x_range = seq(1,5,by=0.2), return_df = TRUE) %>% as.data.frame

df_Rem_911_MCMC_T2_weighted <- df_Rem_911_MCMC_T2_weighted %>% mutate(
across(!starts_with("x"), 
         function(x){return(reverse_beta_squeeze(x, n= length(nine11_BRem_T2$B911_Rem), likert_min_max = c(1,5)))},
         .names = "{.col}_original"))
 
p_Rem_911_MCMC_T2_weighted <- df_Rem_911_MCMC_T2_weighted %>% ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line() +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"), alpha = 0.3, color=NA,
                show.legend = FALSE)

p_Rem_911_MCMC_T2_weighted + 
  ylab('Remembered Negative Emotions') +
  ylim(1,5)+
  xlab('Experienced Negative Emotions') +
  scale_color_manual(labels = c('Previous','Current (after 1 year)'), values = palette2var)+
  scale_fill_manual(values = palette2var)+
  labs(colour='') +
  emomem_theme
ggsave('../Output/fig/pdf/fig_recency_911_T2.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_911_T2.png',height=6,width=6)

```

```{r mcmc interval}
# Fig 2B and 2D
p_coef_covid_weighted <- mcmc_intervals(as.array(Rem_covid_MCMC_weighted), pars = c('Covid_Exp1','Covid_Exp2'),
                                        prob_outer = 0.95)

p_coef_911_weighted_T2 <- mcmc_intervals(as.array(Rem_911_MCMC_T2_weighted), pars = c('prev_experience','curr_experience'), prob_outer = 0.95)

p_coef_covid_weighted + emomem_theme + 
  xlab('Coefficient Estimate') +
  scale_y_discrete(breaks = c('Covid_Exp1','Covid_Exp2'),
                   labels = c('Previous','Current\n(after 1 year)'))
ggsave('../Output/fig/pdf/fig_recency_coef_covid.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_coef_covid.png',height=6,width=6)
  
p_coef_911_weighted_T2 + emomem_theme +
  xlab('Coefficient Estimate') +
  scale_y_discrete(breaks = c('prev_experience','curr_experience'),
                   labels = c('Previous','Current\n(after 1 year)'))
ggsave('../Output/fig/pdf/fig_recency_coef_911.pdf',height=6,width=6)
ggsave('../Output/fig/png/fig_recency_coef_911.png',height=6,width=6)

mcmc_intervals(as.array(Rem_911_MCMC_weighted_ref2), pars = c('prev_experience','curr_experience'))
mcmc_intervals(as.array(Rem_911_MCMC_weighted_ref3), pars = c('prev_experience','curr_experience'))
mcmc_intervals(as.array(Rem_911_MCMC_weighted_ref4), pars = c('prev_experience','curr_experience'))
```

```{r}


covid_long_pca <- covid_wide %>% pivot_longer(cols = c('neg_PCA_T1','neg_PCA_T2'),
                            names_to = 'time',
                            values_to = 'Subjective_Well_being') %>% 
  select(Subject, time, Subjective_Well_being) %>% 
  mutate(time = factor(time, levels = c('neg_PCA_T1','neg_PCA_T2'),
                       labels = c('Previous','Current (after 1 year)')))

p_covid_long_pca <- covid_long_pca %>% ggplot(aes(x=time, y=Subjective_Well_being)) + 
  stat_summary() 
p_covid_long_pca + emomem_theme + 
  xlab('Time') + ylab('Subjective Well-being')

ggsave('../Output/fig/pdf/supp_pca.pdf',height=6,width=7)
ggsave('../Output/fig/png/supp_pca.png',height=6,width=7)

```



```{r well-being}
df_delta_EmoWell <- covid_delta_EmoWell_MCMC %>% plot_model_IVs_stan(variable_array = c('emo_well_being_delta'), x_range = seq(-10,10,by = 0.5), return_df = TRUE) %>% as.data.frame

df_delta_EmoWell <- df_delta_EmoWell %>% mutate(
  across(!starts_with("x"),
         function(x){return(reverse_beta_squeeze(x, n=length(covid_percent %>% filter(!is.na(Covid_Exp1))),
                                                 likert_min_max = c(-4,4)))},
         .names = "{.col}_original"))

p_delta_EmoWell <- df_delta_EmoWell %>% 
ggplot(aes_string(x = "x", y = "predicted_original", group = "x_name", color = "x_name")) +
    geom_line(color = 'black') +
    geom_ribbon(aes_string(ymin = "ymin_original",
                           ymax = "ymax_original" , fill = "x_name"),fill='black', alpha = 0.3, color=NA,
                show.legend = FALSE)

p_delta_EmoWell + 
  geom_vline(xintercept = 0, linetype = 'dashed') + 
  xlab('Emotional Well-being\nImprovement in 1 Year') +
  ylab('Memory Deviation') + 
  emomem_theme + 
  theme(legend.position = 'none')

ggsave('../Output/fig/pdf/delta_wellbeing.pdf',height=6,width=6)
ggsave('../Output/fig/png/delta_wellbeing.png',height=6,width=6)

```

```{r}
p_911_avg <- nine11_percent %>% 
  mutate(time = factor(time, levels = c(2:4),
                       labels = c('1 year','5 years','10 years'))) %>% 
  ggplot(aes(x=time, y=memdev)) + 
    stat_summary() + 
    stat_summary(geom='line', aes(group=1))


p_911_avg + ylab('Memory Deviation') +
  xlab('Time Interval') +
  emomem_theme

ggsave('../Output/fig/pdf/avg_911_time',height=6,width=6)
ggsave('../Output/fig/png/avg_911_time.png',height=6,width=6)

```







```

```{r}
covid_long_type <- covid_wide %>% mutate(BCovid_Exp1 = beta_squeeze((Covid_Exp1-1)/4),
                                         BCovid_Exp2 = beta_squeeze((Covid_Exp2-1)/4),
                                         BCovid_Rem = beta_squeeze(Covid_Rem-1)/4) %>% 
  pivot_longer(cols = c('BCovid_Exp1','BCovid_Exp2','BCovid_Rem'),
               names_to = 'MemType', values_to = 'BStress') %>% 
  mutate(MemType = relevel(factor(MemType), ref='BCovid_Exp1')) %>% 
  filter(!is.na(BStress))
n_ppt <- length(unique(covid_long_type$Subject)) #Calculate number of participants; 726
covid_long_type %>% group_by(MemType) %>% 
  summarise(mean=mean(BStress, na.rm=T), se=sd(BStress, na.rm=T)/sqrt(n_ppt))

#  sanity check: BStress has been beta_squeezed and looks like a beta distribution (that is, fall between 0 and 1)
covid_long_type %>% ggplot(aes(x=BStress)) + geom_histogram(bins = 20) + facet_wrap(~MemType)
if (!exists("MemType_covid_MCMC")) {
MemType_covid_MCMC <- stan_glmer(BStress ~ MemType + (1|Subject), 
                              family = mgcv::betar, iter= niters, seed=seed_no, data = covid_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_covid_MCMC<- covid_long_type$BStress
yrep_y_MemType_covid_MCMC <- posterior_predict(MemType_covid_MCMC, draws = 500)
ppc_dens_overlay(y_MemType_covid_MCMC, yrep_y_MemType_covid_MCMC[1:50, ]) #Looks pretty good!
#Summarize Posterior
plot_model(MemType_covid_MCMC, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_covid_MCMC)

nine11_long_type <- nine11_long_avg_T2 %>% 
  mutate(B911_Exp1 = beta_squeeze((prev_experience-1)/4),
         B911_Exp2 = beta_squeeze((curr_experience-1)/4),
         B911_Rem = beta_squeeze((stress_memory-1)/4)) %>% 
  pivot_longer(cols = c('B911_Exp1', 'B911_Exp2','B911_Rem'),
               names_to = 'MemType', values_to = 'BNegEmo') %>% 
  mutate(MemType = relevel(factor(MemType), ref='B911_Exp1')) %>% 
  filter(!is.na(BNegEmo))
 #Number of 911 participants in case we also need it for SE
n_911_ppt <- length(unique(nine11_long_type$Subject)) #Calculate number of participants; 1430

#   sanity check: BNegEmo has been beta_squeezed
nine11_long_type %>% ggplot(aes(x=BNegEmo)) + geom_histogram(bins = 20) + facet_wrap(~MemType) # may worth noting that sanity check result for covid and 911 looks different
if (!exists("MemType_911_MCMC_T2")) {
MemType_911_MCMC_T2 <- stan_glmer(BNegEmo ~ MemType + (1|Subject), 
                                family = mgcv::betar, iter= niters, seed=seed_no,
                                data = nine11_long_type)
}
#Posterior Predictive Check (Ppc)
y_MemType_911_MCMC_T2<- nine11_long_type$BNegEmo
yrep_MemType_911_MCMC_T2 <- posterior_predict(MemType_911_MCMC_T2, draws = 500)
ppc_dens_overlay(y_MemType_911_MCMC_T2, yrep_MemType_911_MCMC_T2[1:50, ]) #Looks decent, less peaked than data
#Summarize Posterior
plot_model(MemType_911_MCMC_T2, type = "pred", ci.lvl = .95, bpe.color = "red")
describe_posterior(MemType_911_MCMC_T2)

